import Control from"./Control.js";import EventType from"../events/EventType.js";import{CLASS_COLLAPSED,CLASS_CONTROL,CLASS_UNSELECTABLE}from"../css.js";import{equals}from"../array.js";import{removeChildren,replaceNode}from"../dom.js";import{toPromise}from"../functions.js";class Attribution extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target}),this.ulElement_=document.createElement("ul"),this.collapsed_=void 0===e.collapsed||e.collapsed,this.userCollapsed_=this.collapsed_,this.overrideCollapsible_=void 0!==e.collapsible,this.collapsible_=void 0===e.collapsible||e.collapsible,this.collapsible_||(this.collapsed_=!1);var t=void 0!==e.className?e.className:"ol-attribution",l=void 0!==e.tipLabel?e.tipLabel:"Attributions",s=void 0!==e.expandClassName?e.expandClassName:t+"-expand",i=void 0!==e.collapseLabel?e.collapseLabel:"â€º",o=void 0!==e.collapseClassName?e.collapseClassName:t+"-collapse",o=("string"==typeof i?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=i,this.collapseLabel_.className=o):this.collapseLabel_=i,void 0!==e.label?e.label:"i"),i=("string"==typeof o?(this.label_=document.createElement("span"),this.label_.textContent=o,this.label_.className=s):this.label_=o,this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_),e=(this.toggleButton_=document.createElement("button"),this.toggleButton_.setAttribute("type","button"),this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_)),this.toggleButton_.title=l,this.toggleButton_.appendChild(i),this.toggleButton_.addEventListener(EventType.CLICK,this.handleClick_.bind(this),!1),t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"));const a=this.element;a.className=e,a.appendChild(this.toggleButton_),a.appendChild(this.ulElement_),this.renderedAttributions_=[],this.renderedVisible_=!0}collectSourceAttributions_(t){var e=Array.from(new Set(this.getMap().getAllLayers().flatMap(e=>e.getAttributions(t)))),l=!this.getMap().getAllLayers().some(e=>e.getSource()&&!1===e.getSource().getAttributionsCollapsible());return this.overrideCollapsible_||this.setCollapsible(l),e}async updateElement_(e){if(e){var l=await Promise.all(this.collectSourceAttributions_(e).map(e=>toPromise(()=>e))),e=0<l.length;if(this.renderedVisible_!=e&&(this.element.style.display=e?"":"none",this.renderedVisible_=e),!equals(l,this.renderedAttributions_)){removeChildren(this.ulElement_);for(let e=0,t=l.length;e<t;++e){const s=document.createElement("li");s.innerHTML=l[e],this.ulElement_.appendChild(s)}this.renderedAttributions_=l}}else this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1)}handleClick_(e){e.preventDefault(),this.handleToggle_(),this.userCollapsed_=this.collapsed_}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_))}getCollapsible(){return this.collapsible_}setCollapsible(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),this.userCollapsed_&&this.handleToggle_())}setCollapsed(e){this.userCollapsed_=e,this.collapsible_&&this.collapsed_!==e&&this.handleToggle_()}getCollapsed(){return this.collapsed_}render(e){this.updateElement_(e.frameState)}}export default Attribution;