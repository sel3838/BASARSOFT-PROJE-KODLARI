import Feature from"../Feature.js";import Geometry from"../geom/Geometry.js";import LineString from"../geom/LineString.js";import LinearRing from"../geom/LinearRing.js";import MultiLineString from"../geom/MultiLineString.js";import MultiPoint from"../geom/MultiPoint.js";import MultiPolygon from"../geom/MultiPolygon.js";import Point from"../geom/Point.js";import Polygon from"../geom/Polygon.js";import XMLFeature from"./XMLFeature.js";import{extend}from"../array.js";import{getAllTextContent,getAttributeNS,makeArrayPusher,makeReplacer,parseNode,pushParseAndPop}from"../xml.js";import{get as getProjection}from"../proj.js";import{transformExtentWithOptions,transformGeometryWithOptions}from"./Feature.js";const GMLNS="http://www.opengis.net/gml",ONLY_WHITESPACE_RE=/^\s*$/;class GMLBase extends XMLFeature{constructor(e){super(),this.featureType=(e=e||{}).featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:makeArrayPusher(this.readFeaturesInternal),featureMembers:makeReplacer(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(n,e){var s=n.localName;let t=null;if("FeatureCollection"==s)t=pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,n,e,this);else if("featureMembers"==s||"featureMember"==s||"member"==s){const m=e[0];let r=m.featureType,o=m.featureNS;var a;if(!r&&n.childNodes){r=[],o={};for(let e=0,t=n.childNodes.length;e<t;++e){const h=n.childNodes[e];if(1===h.nodeType){var i=h.nodeName.split(":").pop();if(!r.includes(i)){let e="",t=0;var p=h.namespaceURI;for(const d in o){if(o[d]===p){e=d;break}++t}e||(e="p"+t,o[e]=p),r.push(e+":"+i)}}}"featureMember"!=s&&(m.featureType=r,m.featureNS=o)}"string"==typeof o&&(a=o,(o={}).p0=a);const l={},u=Array.isArray(r)?r:[r];for(const P in o){const g={};for(let e=0,t=u.length;e<t;++e)(u[e].includes(":")?u[e].split(":")[0]:"p0")===P&&(g[u[e].split(":").pop()]=("featureMembers"==s?makeArrayPusher:makeReplacer)(this.readFeatureElement,this));l[o[P]]=g}t=pushParseAndPop("featureMember"==s||"member"==s?void 0:[],l,n,e)}return t=null===t?[]:t}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),pushParseAndPop(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){var r=t[0],e=this.readGeometryOrExtent(e,t);return e?transformExtentWithOptions(e,r):void 0}readGeometryElement(e,t){var r=t[0],e=this.readGeometryOrExtent(e,t);return e?transformGeometryWithOptions(e,!1,r):void 0}readFeatureElementInternal(e,o,n){let s;const a={};for(let r=e.firstElementChild;r;r=r.nextElementSibling){let t;var i=r.localName,p=(0===r.childNodes.length||1===r.childNodes.length&&(3===r.firstChild.nodeType||4===r.firstChild.nodeType)?(t=getAllTextContent(r,!1),ONLY_WHITESPACE_RE.test(t)&&(t=void 0)):(t=n?"boundedBy"===i?this.readExtentElement(r,o):this.readGeometryElement(r,o):t)?"boundedBy"!==i&&(s=i):t=this.readFeatureElementInternal(r,o,!1),r.attributes.length);if(0<p&&!(t instanceof Geometry)){t={_content_:t};for(let e=0;e<p;e++){var m=r.attributes[e].name;t[m]=r.attributes[e].value}}a[i]?(a[i]instanceof Array||(a[i]=[a[i]]),a[i].push(t)):a[i]=t}if(!n)return a;const t=new Feature(a);s&&t.setGeometryName(s);e=e.getAttribute("fid")||getAttributeNS(e,this.namespace,"id");return e&&t.setId(e),t}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){e=this.readFlatCoordinatesFromNode(e,t);if(e)return new Point(e,"XYZ")}readMultiPoint(e,t){e=pushParseAndPop([],this.MULTIPOINT_PARSERS,e,t,this);if(e)return new MultiPoint(e)}readMultiLineString(e,t){e=pushParseAndPop([],this.MULTILINESTRING_PARSERS,e,t,this);if(e)return new MultiLineString(e)}readMultiPolygon(e,t){e=pushParseAndPop([],this.MULTIPOLYGON_PARSERS,e,t,this);if(e)return new MultiPolygon(e)}pointMemberParser(e,t){parseNode(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){parseNode(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){parseNode(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){e=this.readFlatCoordinatesFromNode(e,t);if(e)return new LineString(e,"XYZ")}readFlatLinearRing(e,t){e=pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(e)return e}readLinearRing(e,t){e=this.readFlatCoordinatesFromNode(e,t);if(e)return new LinearRing(e,"XYZ")}readPolygon(e,t){var r=pushParseAndPop([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){var o=r[0];const n=[o.length];let e,t;for(e=1,t=r.length;e<t;++e)extend(o,r[e]),n.push(o.length);return new Polygon(o,"XYZ",n)}}readFlatCoordinatesFromNode(e,t){return pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){e=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return e||null}readFeaturesFromNode(e,t){var r={featureType:this.featureType,featureNS:this.featureNS},t=(Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r]));return t||[]}readProjectionFromNode(e){return getProjection(this.srsName||e.firstElementChild.getAttribute("srsName"))}}GMLBase.prototype.namespace=GMLNS,GMLBase.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}},GMLBase.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:makeArrayPusher(GMLBase.prototype.pointMemberParser),pointMembers:makeArrayPusher(GMLBase.prototype.pointMemberParser)}},GMLBase.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:makeArrayPusher(GMLBase.prototype.lineStringMemberParser),lineStringMembers:makeArrayPusher(GMLBase.prototype.lineStringMemberParser)}},GMLBase.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:makeArrayPusher(GMLBase.prototype.polygonMemberParser),polygonMembers:makeArrayPusher(GMLBase.prototype.polygonMemberParser)}},GMLBase.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:makeArrayPusher(GMLBase.prototype.readFlatCoordinatesFromNode)}},GMLBase.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:makeArrayPusher(GMLBase.prototype.readLineString)}},GMLBase.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon)}},GMLBase.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:makeReplacer(GMLBase.prototype.readFlatLinearRing)}};export default GMLBase;export{GMLNS};