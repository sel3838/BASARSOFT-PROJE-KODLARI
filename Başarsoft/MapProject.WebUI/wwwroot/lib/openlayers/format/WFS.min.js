import GML2 from"./GML2.js";import GML3 from"./GML3.js";import GML32 from"./GML32.js";import GMLBase,{GMLNS}from"./GMLBase.js";import XMLFeature from"./XMLFeature.js";import{XML_SCHEMA_INSTANCE_URI,createElementNS,isDocument,makeArrayPusher,makeChildAppender,makeObjectPropertySetter,makeSimpleNodeFactory,parse,parseNode,pushParseAndPop,pushSerializeAndPop}from"../xml.js";import{and as andFilterFn,bbox as bboxFilterFn}from"./filter.js";import{assert}from"../asserts.js";import{get as getProjection}from"../proj.js";import{readNonNegativeIntegerString,readPositiveInteger,writeStringTextNode}from"./xsd.js";const FEATURE_COLLECTION_PARSERS={"http://www.opengis.net/gml":{boundedBy:makeObjectPropertySetter(GMLBase.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:makeArrayPusher(GMLBase.prototype.readFeaturesInternal)}},TRANSACTION_SUMMARY_PARSERS={"http://www.opengis.net/wfs":{totalInserted:makeObjectPropertySetter(readPositiveInteger),totalUpdated:makeObjectPropertySetter(readPositiveInteger),totalDeleted:makeObjectPropertySetter(readPositiveInteger)},"http://www.opengis.net/wfs/2.0":{totalInserted:makeObjectPropertySetter(readPositiveInteger),totalUpdated:makeObjectPropertySetter(readPositiveInteger),totalDeleted:makeObjectPropertySetter(readPositiveInteger)}},TRANSACTION_RESPONSE_PARSERS={"http://www.opengis.net/wfs":{TransactionSummary:makeObjectPropertySetter(readTransactionSummary,"transactionSummary"),InsertResults:makeObjectPropertySetter(readInsertResults,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:makeObjectPropertySetter(readTransactionSummary,"transactionSummary"),InsertResults:makeObjectPropertySetter(readInsertResults,"insertIds")}},QUERY_SERIALIZERS={"http://www.opengis.net/wfs":{PropertyName:makeChildAppender(writeStringTextNode)},"http://www.opengis.net/wfs/2.0":{PropertyName:makeChildAppender(writeStringTextNode)}},TRANSACTION_SERIALIZERS={"http://www.opengis.net/wfs":{Insert:makeChildAppender(writeFeature),Update:makeChildAppender(writeUpdate),Delete:makeChildAppender(writeDelete),Property:makeChildAppender(writeProperty),Native:makeChildAppender(writeNative)},"http://www.opengis.net/wfs/2.0":{Insert:makeChildAppender(writeFeature),Update:makeChildAppender(writeUpdate),Delete:makeChildAppender(writeDelete),Property:makeChildAppender(writeProperty),Native:makeChildAppender(writeNative)}},FEATURE_PREFIX="feature",XMLNS="http://www.w3.org/2000/xmlns/",OGCNS={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},WFSNS={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},FESNS={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},SCHEMA_LOCATIONS={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},GML_FORMATS={"2.0.0":GML32,"1.1.0":GML3,"1.0.0":GML2},DEFAULT_VERSION="1.1.0";class WFS extends XMLFeature{constructor(e){super(),this.version_=(e=e||{}).version||DEFAULT_VERSION,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat||new GML_FORMATS[this.version_],this.schemaLocation_=e.schemaLocation||SCHEMA_LOCATIONS[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){var r={node:e},t=(Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{})),[r]);let i,n=(i="2.0.0"===this.version_?FEATURE_COLLECTION_PARSERS:this.gmlFormat_.FEATURE_COLLECTION_PARSERS,pushParseAndPop([],i,e,t,this.gmlFormat_));return n=n||[]}readTransactionResponse(e){var t;if(e)return"string"==typeof e?(t=parse(e),this.readTransactionResponseFromDocument(t)):isDocument(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}readFeatureCollectionMetadata(e){var t;if(e)return"string"==typeof e?(t=parse(e),this.readFeatureCollectionMetadataFromDocument(t)):isDocument(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}readFeatureCollectionMetadataFromDocument(t){for(let e=t.firstChild;e;e=e.nextSibling)if(e.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(e)}readFeatureCollectionMetadataFromNode(e){const t={};var r=readNonNegativeIntegerString(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,pushParseAndPop(t,FEATURE_COLLECTION_PARSERS,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(t){for(let e=t.firstChild;e;e=e.nextSibling)if(e.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(e)}readTransactionResponseFromNode(e){return pushParseAndPop({},TRANSACTION_RESPONSE_PARSERS,e,[])}writeGetFeature(r){const i=createElementNS(WFSNS[this.version_],"GetFeature"),n=(i.setAttribute("service","WFS"),i.setAttribute("version",this.version_),r.handle&&i.setAttribute("handle",r.handle),r.outputFormat&&i.setAttribute("outputFormat",r.outputFormat),void 0!==r.maxFeatures&&i.setAttribute("maxFeatures",String(r.maxFeatures)),r.resultType&&i.setAttribute("resultType",r.resultType),void 0!==r.startIndex&&i.setAttribute("startIndex",String(r.startIndex)),void 0!==r.count&&i.setAttribute("count",String(r.count)),void 0!==r.viewParams&&i.setAttribute("viewParams",r.viewParams),i.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",this.schemaLocation_),{node:i});if(Object.assign(n,{version:this.version_,srsName:r.srsName,featureNS:r.featureNS||this.featureNS_,featurePrefix:r.featurePrefix,propertyNames:r.propertyNames||[]}),assert(Array.isArray(r.featureTypes),"`options.featureTypes` must be an Array"),"string"==typeof r.featureTypes[0]){let e=r.filter;r.bbox&&(assert(r.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),e=this.combineBboxAndFilter(r.geometryName,r.bbox,r.srsName,e)),Object.assign(n,{geometryName:r.geometryName,filter:e}),writeGetFeature(i,r.featureTypes,[n])}else r.featureTypes.forEach(e=>{var t=this.combineBboxAndFilter(e.geometryName,e.bbox,r.srsName,r.filter);Object.assign(n,{geometryName:e.geometryName,filter:t}),writeGetFeature(i,[e.name],[n])});return i}combineBboxAndFilter(e,t,r,i){e=bboxFilterFn(e,t,r);return i?andFilterFn(i,e):e}writeTransaction(e,t,r,i){var n=[],a=i.version||this.version_;const o=createElementNS(WFSNS[a],"Transaction");o.setAttribute("service","WFS"),o.setAttribute("version",a);let s;i&&(s=i.gmlOptions||{},i.handle&&o.setAttribute("handle",i.handle)),o.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",SCHEMA_LOCATIONS[a]);a=createTransactionRequest(o,s,a,i);return e&&serializeTransactionRequest("Insert",e,n,a),t&&serializeTransactionRequest("Update",t,n,a),r&&serializeTransactionRequest("Delete",r,n,a),i.nativeElements&&serializeTransactionRequest("Native",i.nativeElements,n,a),o}readProjectionFromDocument(t){for(let e=t.firstChild;e;e=e.nextSibling)if(e.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(e);return null}readProjectionFromNode(t){if(t.firstElementChild&&t.firstElementChild.firstElementChild)for(let e=(t=t.firstElementChild.firstElementChild).firstElementChild;e;e=e.nextElementSibling)if(0!==e.childNodes.length&&(1!==e.childNodes.length||3!==e.firstChild.nodeType)){const r=[{}];return this.gmlFormat_.readGeometryElement(e,r),getProjection(r.pop().srsName)}return null}}function createTransactionRequest(e,t,r,i){var n=i.featurePrefix||FEATURE_PREFIX;let a;return"1.0.0"===r?a=2:"1.1.0"===r?a=3:"2.0.0"===r&&(a=3.2),Object.assign({node:e},{version:r,featureNS:i.featureNS,featureType:i.featureType,featurePrefix:n,gmlVersion:a,hasZ:i.hasZ,srsName:i.srsName},t)}function serializeTransactionRequest(e,t,r,i){pushSerializeAndPop(i,TRANSACTION_SERIALIZERS,makeSimpleNodeFactory(e),t,r)}function readTransactionSummary(e,t){return pushParseAndPop({},TRANSACTION_SUMMARY_PARSERS,e,t)}const OGC_FID_PARSERS={"http://www.opengis.net/ogc":{FeatureId:makeArrayPusher(function(e,t){return e.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:makeArrayPusher(function(e,t){return e.getAttribute("fid")})}};function fidParser(e,t){parseNode(OGC_FID_PARSERS,e,t)}const INSERT_RESULTS_PARSERS={"http://www.opengis.net/wfs":{Feature:fidParser},"http://www.opengis.net/wfs/2.0":{Feature:fidParser}};function readInsertResults(e,t){return pushParseAndPop([],INSERT_RESULTS_PARSERS,e,t)}function writeFeature(e,t,r){var i=r[r.length-1],n=i.featureType,a=i.featureNS,i=i.gmlVersion,a=createElementNS(a,n);e.appendChild(a),(2===i?GML2:3===i?GML3:GML32).prototype.writeFeatureElement(a,t,r)}function writeOgcFidFilter(e,t,r){r=r[r.length-1].version,r=OGCNS[r];const i=createElementNS(r,"Filter"),n=createElementNS(r,"FeatureId");i.appendChild(n),n.setAttribute("fid",t),e.appendChild(i)}function getTypeName(e,t){e=(e=e||FEATURE_PREFIX)+":";return t.startsWith(e)?t:e+t}function writeDelete(e,t,r){var i=r[r.length-1],n=(assert(void 0!==t.getId(),"Features must have an id set"),i.featureType),a=i.featurePrefix,i=i.featureNS,n=getTypeName(a,n),n=(e.setAttribute("typeName",n),e.setAttributeNS(XMLNS,"xmlns:"+a,i),t.getId());void 0!==n&&writeOgcFidFilter(e,n,r)}function writeUpdate(e,r,t){var i=t[t.length-1],n=(assert(void 0!==r.getId(),"Features must have an id set"),i.version),a=i.featureType,o=i.featurePrefix,s=i.featureNS,a=getTypeName(o,a),p=r.getGeometryName(),a=(e.setAttribute("typeName",a),e.setAttributeNS(XMLNS,"xmlns:"+o,s),r.getId());if(void 0!==a){var l=r.getKeys();const m=[];for(let t=0,e=l.length;t<e;t++){var d=r.get(l[t]);if(void 0!==d){let e=l[t];d&&"function"==typeof d.getSimplifiedGeometry&&(e=p),m.push({name:e,value:d})}}pushSerializeAndPop({version:n,gmlVersion:i.gmlVersion,node:e,hasZ:i.hasZ,srsName:i.srsName},TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Property"),m,t),writeOgcFidFilter(e,a,t)}}function writeProperty(e,t,r){var i=r[r.length-1],n=i.version,a=WFSNS[n],n=createElementNS(a,"2.0.0"===n?"ValueReference":"Name"),i=i.gmlVersion;e.appendChild(n),writeStringTextNode(n,t.name),void 0!==t.value&&null!==t.value&&(n=createElementNS(a,"Value"),e.appendChild(n),t.value&&"function"==typeof t.value.getSimplifiedGeometry?(2===i?GML2:3===i?GML3:GML32).prototype.writeGeometryElement(n,t.value,r):writeStringTextNode(n,t.value))}function writeNative(e,t,r){t.vendorId&&e.setAttribute("vendorId",t.vendorId),void 0!==t.safeToIgnore&&e.setAttribute("safeToIgnore",String(t.safeToIgnore)),void 0!==t.value&&writeStringTextNode(e,t.value)}const GETFEATURE_SERIALIZERS={"http://www.opengis.net/wfs":{Query:makeChildAppender(writeQuery)},"http://www.opengis.net/wfs/2.0":{Query:makeChildAppender(writeQuery)},"http://www.opengis.net/ogc":{During:makeChildAppender(writeDuringFilter),And:makeChildAppender(writeLogicalFilter),Or:makeChildAppender(writeLogicalFilter),Not:makeChildAppender(writeNotFilter),BBOX:makeChildAppender(writeBboxFilter),Contains:makeChildAppender(writeSpatialFilter),Intersects:makeChildAppender(writeSpatialFilter),Within:makeChildAppender(writeSpatialFilter),DWithin:makeChildAppender(writeDWithinFilter),PropertyIsEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNotEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsLessThan:makeChildAppender(writeComparisonFilter),PropertyIsLessThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThan:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNull:makeChildAppender(writeIsNullFilter),PropertyIsBetween:makeChildAppender(writeIsBetweenFilter),PropertyIsLike:makeChildAppender(writeIsLikeFilter)},"http://www.opengis.net/fes/2.0":{During:makeChildAppender(writeDuringFilter),And:makeChildAppender(writeLogicalFilter),Or:makeChildAppender(writeLogicalFilter),Not:makeChildAppender(writeNotFilter),BBOX:makeChildAppender(writeBboxFilter),Contains:makeChildAppender(writeSpatialFilter),Disjoint:makeChildAppender(writeSpatialFilter),Intersects:makeChildAppender(writeSpatialFilter),ResourceId:makeChildAppender(writeResourceIdFilter),Within:makeChildAppender(writeSpatialFilter),DWithin:makeChildAppender(writeDWithinFilter),PropertyIsEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNotEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsLessThan:makeChildAppender(writeComparisonFilter),PropertyIsLessThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThan:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNull:makeChildAppender(writeIsNullFilter),PropertyIsBetween:makeChildAppender(writeIsBetweenFilter),PropertyIsLike:makeChildAppender(writeIsLikeFilter)}};function writeQuery(e,t,r){var i=r[r.length-1],n=i.version,a=i.featurePrefix,o=i.featureNS,s=i.propertyNames,p=i.srsName;let l;l=a?getTypeName(a,t):t;let d;d="2.0.0"===n?"typeNames":"typeName",e.setAttribute(d,l),p&&e.setAttribute("srsName",p),o&&e.setAttributeNS(XMLNS,"xmlns:"+a,o);const m=Object.assign({},i);m.node=e,pushSerializeAndPop(m,QUERY_SERIALIZERS,makeSimpleNodeFactory("PropertyName"),s,r);t=i.filter;t&&(p=createElementNS(getFilterNS(n),"Filter"),e.appendChild(p),writeFilterCondition(p,t,r))}function writeFilterCondition(e,t,r){var i=r[r.length-1],e={node:e};Object.assign(e,{context:i}),pushSerializeAndPop(e,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(t.getTagName()),[t],r)}function writeBboxFilter(e,t,r){const i=r[r.length-1];var n=i.context.version;i.srsName=t.srsName;const a=GML_FORMATS[n];writePropertyName(n,e,t.geometryName),a.prototype.writeGeometryElement(e,t.extent,r)}function writeResourceIdFilter(e,t,r){e.setAttribute("rid",t.rid)}function writeSpatialFilter(e,t,r){const i=r[r.length-1];var n=i.context.version;i.srsName=t.srsName;const a=GML_FORMATS[n];writePropertyName(n,e,t.geometryName),a.prototype.writeGeometryElement(e,t.geometry,r)}function writeDWithinFilter(e,t,r){var i=r[r.length-1].context.version;writeSpatialFilter(e,t,r);const n=createElementNS(getFilterNS(i),"Distance");writeStringTextNode(n,t.distance.toString()),"2.0.0"===i?n.setAttribute("uom",t.unit):n.setAttribute("units",t.unit),e.appendChild(n)}function writeDuringFilter(e,t,r){r=r[r.length-1].context.version;writeExpression(FESNS[r],"ValueReference",e,t.propertyName);const i=createElementNS(GMLNS,"TimePeriod");e.appendChild(i);r=createElementNS(GMLNS,"begin"),i.appendChild(r),writeTimeInstant(r,t.begin),e=createElementNS(GMLNS,"end");i.appendChild(e),writeTimeInstant(e,t.end)}function writeLogicalFilter(e,t,r){var i=r[r.length-1].context,n={node:e},a=(Object.assign(n,{context:i}),t.conditions);for(let e=0,t=a.length;e<t;++e){const o=a[e];pushSerializeAndPop(n,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(o.getTagName()),[o],r)}}function writeNotFilter(e,t,r){var i=r[r.length-1].context,e={node:e};Object.assign(e,{context:i});const n=t.condition;pushSerializeAndPop(e,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(n.getTagName()),[n],r)}function writeComparisonFilter(e,t,r){r=r[r.length-1].context.version;void 0!==t.matchCase&&e.setAttribute("matchCase",t.matchCase.toString()),writePropertyName(r,e,t.propertyName),writeLiteral(r,e,""+t.expression)}function writeIsNullFilter(e,t,r){writePropertyName(r[r.length-1].context.version,e,t.propertyName)}function writeIsBetweenFilter(e,t,r){var r=r[r.length-1].context.version,i=getFilterNS(r),n=(writePropertyName(r,e,t.propertyName),createElementNS(i,"LowerBoundary")),n=(e.appendChild(n),writeLiteral(r,n,""+t.lowerBoundary),createElementNS(i,"UpperBoundary"));e.appendChild(n),writeLiteral(r,n,""+t.upperBoundary)}function writeIsLikeFilter(e,t,r){r=r[r.length-1].context.version;e.setAttribute("wildCard",t.wildCard),e.setAttribute("singleChar",t.singleChar),e.setAttribute("escapeChar",t.escapeChar),void 0!==t.matchCase&&e.setAttribute("matchCase",t.matchCase.toString()),writePropertyName(r,e,t.propertyName),writeLiteral(r,e,""+t.pattern)}function writeExpression(e,t,r,i){e=createElementNS(e,t);writeStringTextNode(e,i),r.appendChild(e)}function writeLiteral(e,t,r){writeExpression(getFilterNS(e),"Literal",t,r)}function writePropertyName(e,t,r){"2.0.0"===e?writeExpression(FESNS[e],"ValueReference",t,r):writeExpression(OGCNS[e],"PropertyName",t,r)}function writeTimeInstant(e,t){const r=createElementNS(GMLNS,"TimeInstant");e.appendChild(r);e=createElementNS(GMLNS,"timePosition");r.appendChild(e),writeStringTextNode(e,t)}function writeFilter(e,t){var r=createElementNS(getFilterNS(t=t||"1.1.0"),"Filter"),i={node:r};return Object.assign(i,{version:t,filter:e}),writeFilterCondition(r,e,[i]),r}function writeGetFeature(e,t,r){var i=r[r.length-1];const n=Object.assign({},i);n.node=e,pushSerializeAndPop(n,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory("Query"),t,r)}function getFilterNS(e){let t;return t=("2.0.0"===e?FESNS:OGCNS)[e]}export default WFS;export{writeFilter};