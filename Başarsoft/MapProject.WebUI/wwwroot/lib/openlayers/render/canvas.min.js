import BaseObject from"../Object.js";import{WORKER_OFFSCREEN_CANVAS}from"../has.js";import{clear}from"../obj.js";import{createCanvasContext2D}from"../dom.js";import{getFontParameters}from"../css.js";const defaultFont="10px sans-serif",defaultFillStyle="#000",defaultLineCap="round",defaultLineDash=[],defaultLineDashOffset=0,defaultLineJoin="round",defaultMiterLimit=10,defaultStrokeStyle="#000",defaultTextAlign="center",defaultTextBaseline="middle",defaultPadding=[0,0,0,0],defaultLineWidth=1,checkedFonts=new BaseObject;let measureContext=null,measureFont;const textHeights={},registerFont=function(){const i="32px ",o=["monospace","serif"],l=o.length,u="wmytzilWMYTZIL@#/&?$%10";let d,c;function h(t,n,a){let s=!0;for(let e=0;e<l;++e){var r=o[e];c=measureTextWidth(t+" "+n+" "+i+r,u),a!=r&&(r=measureTextWidth(t+" "+n+" "+i+a+","+r,u),s=s&&r!=c)}return!!s}function f(){let n=!0;var a=checkedFonts.getKeys();for(let e=0,t=a.length;e<t;++e){const s=a[e];checkedFonts.get(s)<100&&(h.apply(this,s.split("\n"))?(clear(textHeights),measureContext=null,measureFont=void 0,checkedFonts.set(s,100)):(checkedFonts.set(s,checkedFonts.get(s)+1,!0),n=!1))}n&&(clearInterval(d),d=void 0)}return function(e){var n=getFontParameters(e);if(n){var a=n.families;for(let e=0,t=a.length;e<t;++e){var s=a[e],r=n.style+"\n"+n.weight+"\n"+s;void 0===checkedFonts.get(r)&&(checkedFonts.set(r,100,!0),h(n.style,n.weight,s)||(checkedFonts.set(r,0,!0),void 0===d&&(d=setInterval(f,32))))}}}}(),measureTextHeight=function(){let s;return function(e){let t=textHeights[e];var n,a;return null==t&&(WORKER_OFFSCREEN_CANVAS?(a=getFontParameters(e),n=measureText(e,"Žg"),a=isNaN(Number(a.lineHeight))?1.2:Number(a.lineHeight),t=a*(n.actualBoundingBoxAscent+n.actualBoundingBoxDescent)):(s||((s=document.createElement("div")).innerHTML="M",s.style.minHeight="0",s.style.maxHeight="none",s.style.height="auto",s.style.padding="0",s.style.border="none",s.style.position="absolute",s.style.display="block",s.style.left="-99999px"),s.style.font=e,document.body.appendChild(s),t=s.offsetHeight,document.body.removeChild(s)),textHeights[e]=t),t}}();function measureText(e,t){return measureContext=measureContext||createCanvasContext2D(1,1),e!=measureFont&&(measureContext.font=e,measureFont=measureContext.font),measureContext.measureText(t)}function measureTextWidth(e,t){return measureText(e,t).width}function measureAndCacheTextWidth(n,e,t){if(e in t)return t[e];var a=e.split("\n").reduce((e,t)=>Math.max(e,measureTextWidth(n,t)),0);return t[e]=a}function getTextDimensions(n,a){const s=[],r=[],i=[];let o=0,l=0,u=0,d=0;for(let e=0,t=a.length;e<=t;e+=2){var c,h=a[e];"\n"===h||e===t?(o=Math.max(o,l),i.push(l),l=0,u+=d,d=0):(h=measureTextWidth(c=a[e+1]||n.font,h),h=(s.push(h),l+=h,measureTextHeight(c)),r.push(h),d=Math.max(d,h))}return{width:o,height:u,widths:s,heights:r,lineWidths:i}}function rotateAtOffset(e,t,n,a){0!==t&&(e.translate(n,a),e.rotate(t),e.translate(-n,-a))}function drawImageOrLabel(e,t,n,a,s,r,i,o,l,u,d){e.save(),1!==n&&(void 0===e.globalAlpha?e.globalAlpha=e=>e.globalAlpha*=n:e.globalAlpha*=n),t&&e.transform.apply(e,t),a.contextInstructions?(e.translate(l,u),e.scale(d[0],d[1]),executeLabelInstructions(a,e)):d[0]<0||d[1]<0?(e.translate(l,u),e.scale(d[0],d[1]),e.drawImage(a,s,r,i,o,0,0,i,o)):e.drawImage(a,s,r,i,o,l,u,i*d[0],o*d[1]),e.restore()}function executeLabelInstructions(e,n){var a=e.contextInstructions;for(let e=0,t=a.length;e<t;e+=2)Array.isArray(a[e+1])?n[a[e]].apply(n,a[e+1]):n[a[e]]=a[e+1]}export{defaultFont,defaultFillStyle,defaultLineCap,defaultLineDash,defaultLineDashOffset,defaultLineJoin,defaultMiterLimit,defaultStrokeStyle,defaultTextAlign,defaultTextBaseline,defaultPadding,defaultLineWidth,checkedFonts,textHeights,registerFont,measureTextHeight,measureTextWidth,measureAndCacheTextWidth,getTextDimensions,rotateAtOffset,drawImageOrLabel};