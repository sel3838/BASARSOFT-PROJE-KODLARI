import CanvasInstruction from"./Instruction.js";import Relationship from"../../extent/Relationship.js";import VectorContext from"../VectorContext.js";import{asColorLike}from"../../colorlike.js";import{buffer,clone,containsCoordinate,coordinateRelationship}from"../../extent.js";import{defaultFillStyle,defaultLineCap,defaultLineDash,defaultLineDashOffset,defaultLineJoin,defaultLineWidth,defaultMiterLimit,defaultStrokeStyle}from"../canvas.js";import{equals,reverseSubArray}from"../../array.js";import{inflateCoordinates,inflateCoordinatesArray,inflateMultiCoordinatesArray}from"../../geom/flat/inflate.js";class CanvasBuilder extends VectorContext{constructor(t,e,i,n){super(),this.tolerance=t,this.maxExtent=e,this.pixelRatio=n,this.maxLineWidth=0,this.resolution=i,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const e=this.pixelRatio;return 1==e?t:t.map(function(t){return t*e})}appendFlatPointCoordinates(i,n){var s=this.getBufferedMaxExtent();const r=this.tmpCoordinate_,o=this.coordinates;let a=o.length;for(let t=0,e=i.length;t<e;t+=n)r[0]=i[t],r[1]=i[t+1],containsCoordinate(s,r)&&(o[a++]=r[0],o[a++]=r[1]);return a}appendFlatLineCoordinates(t,e,i,n,s,r){const o=this.coordinates;let a=o.length;var l=this.getBufferedMaxExtent();r&&(e+=n);let h=t[e],u=t[e+1];const c=this.tmpCoordinate_;let d=!0,f,C,p;for(f=e+n;f<i;f+=n)c[0]=t[f],c[1]=t[f+1],(p=coordinateRelationship(l,c))!==C?(d&&(o[a++]=h,o[a++]=u,d=!1),o[a++]=c[0],o[a++]=c[1]):d=p!==Relationship.INTERSECTING||(o[a++]=c[0],o[a++]=c[1],!1),h=c[0],u=c[1],C=p;return(s&&d||f===e+n)&&(o[a++]=h,o[a++]=u),a}drawCustomCoordinates_(i,n,s,r,o){for(let t=0,e=s.length;t<e;++t){var a=s[t],l=this.appendFlatLineCoordinates(i,n,a,r,!1,!1);o.push(l),n=a}return n}drawCustom(t,e,i,n,s){this.beginGeometry(t,e,s);var r=t.getType(),o=t.getStride(),a=this.coordinates.length;let l,h,u,c,d;switch(r){case"MultiPolygon":l=t.getOrientedFlatCoordinates(),c=[];var f=t.getEndss();for(let t=d=0,e=f.length;t<e;++t){var C=[];d=this.drawCustomCoordinates_(l,d,f[t],o,C),c.push(C)}this.instructions.push([CanvasInstruction.CUSTOM,a,c,t,i,inflateMultiCoordinatesArray,s]),this.hitDetectionInstructions.push([CanvasInstruction.CUSTOM,a,c,t,n||i,inflateMultiCoordinatesArray,s]);break;case"Polygon":case"MultiLineString":u=[],l="Polygon"==r?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),d=this.drawCustomCoordinates_(l,0,t.getEnds(),o,u),this.instructions.push([CanvasInstruction.CUSTOM,a,u,t,i,inflateCoordinatesArray,s]),this.hitDetectionInstructions.push([CanvasInstruction.CUSTOM,a,u,t,n||i,inflateCoordinatesArray,s]);break;case"LineString":case"Circle":l=t.getFlatCoordinates(),h=this.appendFlatLineCoordinates(l,0,l.length,o,!1,!1),this.instructions.push([CanvasInstruction.CUSTOM,a,h,t,i,inflateCoordinates,s]),this.hitDetectionInstructions.push([CanvasInstruction.CUSTOM,a,h,t,n||i,inflateCoordinates,s]);break;case"MultiPoint":l=t.getFlatCoordinates(),(h=this.appendFlatPointCoordinates(l,o))>a&&(this.instructions.push([CanvasInstruction.CUSTOM,a,h,t,i,inflateCoordinates,s]),this.hitDetectionInstructions.push([CanvasInstruction.CUSTOM,a,h,t,n||i,inflateCoordinates,s]));break;case"Point":l=t.getFlatCoordinates(),this.coordinates.push(l[0],l[1]),h=this.coordinates.length,this.instructions.push([CanvasInstruction.CUSTOM,a,h,t,i,void 0,s]),this.hitDetectionInstructions.push([CanvasInstruction.CUSTOM,a,h,t,n||i,void 0,s])}this.endGeometry(e)}beginGeometry(t,e,i){this.beginGeometryInstruction1_=[CanvasInstruction.BEGIN_GEOMETRY,e,0,t,i],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[CanvasInstruction.BEGIN_GEOMETRY,e,0,t,i],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let e;var i,n=t.length;let s,r=-1;for(e=0;e<n;++e)(i=(s=t[e])[0])==CanvasInstruction.END_GEOMETRY?r=e:i==CanvasInstruction.BEGIN_GEOMETRY&&(s[2]=e,reverseSubArray(this.hitDetectionInstructions,r,e),r=-1)}setFillStrokeStyle(t,e){const i=this.state;if(t?(t=t.getColor(),i.fillPatternScale=t&&"object"==typeof t&&"src"in t?this.pixelRatio:1,i.fillStyle=asColorLike(t||defaultFillStyle)):i.fillStyle=void 0,e){t=e.getColor(),t=(i.strokeStyle=asColorLike(t||defaultStrokeStyle),e.getLineCap());i.lineCap=void 0!==t?t:defaultLineCap;const n=e.getLineDash();i.lineDash=n?n.slice():defaultLineDash;t=e.getLineDashOffset(),t=(i.lineDashOffset=t||defaultLineDashOffset,e.getLineJoin()),t=(i.lineJoin=void 0!==t?t:defaultLineJoin,e.getWidth()),t=(i.lineWidth=void 0!==t?t:defaultLineWidth,e.getMiterLimit());i.miterLimit=void 0!==t?t:defaultMiterLimit,i.lineWidth>this.maxLineWidth&&(this.maxLineWidth=i.lineWidth,this.bufferedMaxExtent_=null)}else i.strokeStyle=void 0,i.lineCap=void 0,i.lineDash=null,i.lineDashOffset=void 0,i.lineJoin=void 0,i.lineWidth=void 0,i.miterLimit=void 0}createFill(t){var e=t.fillStyle;const i=[CanvasInstruction.SET_FILL_STYLE,e];return"string"!=typeof e&&i.push(t.fillPatternScale),i}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[CanvasInstruction.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,this.applyPixelRatio(t.lineDash),t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,e){var i=t.fillStyle;"string"==typeof i&&t.currentFillStyle==i||(void 0!==i&&this.instructions.push(e.call(this,t)),t.currentFillStyle=i)}updateStrokeStyle(t,e){var i=t.strokeStyle,n=t.lineCap,s=t.lineDash,r=t.lineDashOffset,o=t.lineJoin,a=t.lineWidth,l=t.miterLimit;t.currentStrokeStyle==i&&t.currentLineCap==n&&(s==t.currentLineDash||equals(t.currentLineDash,s))&&t.currentLineDashOffset==r&&t.currentLineJoin==o&&t.currentLineWidth==a&&t.currentMiterLimit==l||(void 0!==i&&e.call(this,t),t.currentStrokeStyle=i,t.currentLineCap=n,t.currentLineDash=s,t.currentLineDashOffset=r,t.currentLineJoin=o,t.currentLineWidth=a,t.currentMiterLimit=l)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;t=[CanvasInstruction.END_GEOMETRY,t];this.instructions.push(t),this.hitDetectionInstructions.push(t)}getBufferedMaxExtent(){var t;return this.bufferedMaxExtent_||(this.bufferedMaxExtent_=clone(this.maxExtent),0<this.maxLineWidth&&(t=this.resolution*(this.maxLineWidth+1)/2,buffer(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_))),this.bufferedMaxExtent_}}export default CanvasBuilder;