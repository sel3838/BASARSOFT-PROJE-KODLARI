import CanvasInstruction from"./Instruction.js";import ZIndexContext from"../canvas/ZIndexContext.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{apply as applyTransform,compose as composeTransform,create as createTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createEmpty,createOrUpdate,intersects}from"../../extent.js";import{defaultPadding,defaultTextAlign,defaultTextBaseline,drawImageOrLabel,getTextDimensions,measureAndCacheTextWidth}from"../canvas.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{equals}from"../../array.js";import{lineStringLength}from"../../geom/flat/length.js";import{transform2D}from"../../geom/flat/transform.js";const tmpExtent=createEmpty(),p1=[],p2=[],p3=[],p4=[];function getDeclutterBox(t){return t[3].declutterBox}const rtlRegEx=new RegExp("["+String.fromCharCode(1425)+"-"+String.fromCharCode(2303)+String.fromCharCode(64285)+"-"+String.fromCharCode(65023)+String.fromCharCode(65136)+"-"+String.fromCharCode(65276)+String.fromCharCode(67584)+"-"+String.fromCharCode(69631)+String.fromCharCode(124928)+"-"+String.fromCharCode(126975)+"]");function horizontalTextAlign(t,e){return"start"===e?e=rtlRegEx.test(t)?"right":"left":"end"===e&&(e=rtlRegEx.test(t)?"left":"right"),TEXT_ALIGN[e]}function createTextChunks(t,e,a){return 0<a&&t.push("\n",""),t.push(e,""),t}class Executor{constructor(t,e,a,i,r){this.overlaps=a,this.pixelRatio=e,this.resolution=t,this.alignAndScaleFill_,this.instructions=i.instructions,this.coordinates=i.coordinates,this.coordinateCache_={},this.renderedTransform_=createTransform(),this.hitDetectionInstructions=i.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=i.fillStates||{},this.strokeStates=i.strokeStates||{},this.textStates=i.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=r?new ZIndexContext:null}getZIndexContext(){return this.zIndexContext_}createLabel(a,t,i,r){var e=a+t+i+r;if(this.labels_[e])return this.labels_[e];var s=r?this.strokeStates[r]:null,n=i?this.fillStates[i]:null,l=this.textStates[t],t=this.pixelRatio,t=[l.scale[0]*t,l.scale[1]*t],o=Array.isArray(a),h=l.justify?TEXT_ALIGN[l.justify]:horizontalTextAlign(Array.isArray(a)?a[0]:a,l.textAlign||defaultTextAlign),c=r&&s.lineWidth?s.lineWidth:0,p=o?a:a.split("\n").reduce(createTextChunks,[]),{width:o,height:a,widths:d,heights:u,lineWidths:m}=getTextDimensions(l,p),f=o+c;const x=[];var g,o=(f+2)*t[0],a=(a+c)*t[1],o={width:o<0?Math.floor(o):Math.ceil(o),height:a<0?Math.floor(a):Math.ceil(a),contextInstructions:x},_=(1==t[0]&&1==t[1]||x.push("scale",t),r&&(x.push("strokeStyle",s.strokeStyle),x.push("lineWidth",c),x.push("lineCap",s.lineCap),x.push("lineJoin",s.lineJoin),x.push("miterLimit",s.miterLimit),x.push("setLineDash",[s.lineDash]),x.push("lineDashOffset",s.lineDashOffset)),i&&x.push("fillStyle",n.fillStyle),x.push("textBaseline","middle"),x.push("textAlign","center"),.5-h);let T=h*f+_*c;const C=[],I=[];let v=0,y=0,S=0,b=0,A;for(let t=0,e=p.length;t<e;t+=2){const a=p[t];"\n"===a?(y+=v,v=0,T=h*f+_*c,++b):(g=((g=p[t+1]||l.font)!==A&&(r&&C.push("font",g),i&&I.push("font",g),A=g),v=Math.max(v,u[S]),[a,T+_*d[S]+h*(d[S]-m[b]),.5*(c+v)+y]),T+=d[S],r&&C.push("strokeText",g),i&&I.push("fillText",g),++S)}return Array.prototype.push.apply(x,C),Array.prototype.push.apply(x,I),this.labels_[e]=o}replayTextBackground_(t,e,a,i,r,s,n){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,a),t.lineTo.apply(t,i),t.lineTo.apply(t,r),t.lineTo.apply(t,e),s&&(this.alignAndScaleFill_=s[2],this.fill_(t)),n&&(this.setStrokeStyle_(t,n),t.stroke())}calculateImageOrLabelDimensions_(t,e,a,i,r,s,n,l,o,h,c,p,d,u,m,f){let x=a-(n*=p[0]),g=i-(l*=p[1]);n=t<r+o?t-o:r,l=e<s+h?e-h:s,t=u[3]+n*p[0]+u[1],r=u[0]+l*p[1]+u[2],e=x-u[3],s=g-u[0];!m&&0===c||(p1[0]=e,p4[0]=e,p1[1]=s,p2[1]=s,p2[0]=e+t,p3[0]=p2[0],p3[1]=s+r,p4[1]=p3[1]);let _;return 0!==c?(_=composeTransform(createTransform(),a,i,1,1,c,-a,-i),applyTransform(_,p1),applyTransform(_,p2),applyTransform(_,p3),applyTransform(_,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(Math.min(e,e+t),Math.min(s,s+r),Math.max(e,e+t),Math.max(s,s+r),tmpExtent),d&&(x=Math.round(x),g=Math.round(g)),{drawImageX:x,drawImageY:g,drawImageW:n,drawImageH:l,originX:o,originY:h,declutterBox:{minX:tmpExtent[0],minY:tmpExtent[1],maxX:tmpExtent[2],maxY:tmpExtent[3],value:f},canvasTransform:_,scale:p}}replayImageOrLabel_(t,e,a,i,r,s,n){var l=i.declutterBox,o=n?n[2]*i.scale[0]/2:0;return l.minX-o<=e[0]&&0<=l.maxX+o&&l.minY-o<=e[1]&&0<=l.maxY+o&&(!(!s&&!n)&&this.replayTextBackground_(t,p1,p2,p3,p4,s,n),drawImageOrLabel(t,i.canvasTransform,r,a,i.originX,i.originY,i.drawImageW,i.drawImageH,i.drawImageX,i.drawImageY,i.scale)),!0}fill_(t){var e,a,i=this.alignAndScaleFill_;i&&(e=applyTransform(this.renderedTransform_,[0,0]),a=512*this.pixelRatio,t.save(),t.translate(e[0]%a,e[1]%a),1!==i&&t.scale(i,i),t.rotate(this.viewRotation_)),t.fill(),i&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.lineDashOffset=e[7],t.setLineDash(e[6])}drawLabelWithPointPlacement_(t,e,a,i){var r=this.textStates[e],e=this.createLabel(t,e,i,a),i=this.strokeStates[a],a=this.pixelRatio,t=horizontalTextAlign(Array.isArray(t)?t[0]:t,r.textAlign||defaultTextAlign),s=TEXT_ALIGN[r.textBaseline||defaultTextBaseline],i=i&&i.lineWidth?i.lineWidth:0;return{label:e,anchorX:t*(e.width/a-2*r.scale[0])+2*(.5-t)*i,anchorY:s*e.height/a+2*(.5-s)*i}}execute_(h,F,t,e,H,U,Z,c){const p=this.zIndexContext_;let d,u=(this.pixelCoordinates_&&equals(t,this.renderedTransform_)?d=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),d=transform2D(this.coordinates,0,this.coordinates.length,2,t,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,t)),0);var a=e.length;let m=0,f,x,g,_,T,C,q,J,I,v,y,S,b,A=0,w=0,K=null,V=null;const Q=this.coordinateCache_;var $=this.viewRotation_,tt=Math.round(1e12*Math.atan2(-t[1],t[0]))/1e12;const et={context:h,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:$};var at=this.instructions!=e||this.overlaps?0:200;let E,L,k,it;for(;u<a;){const j=e[u];switch(j[0]){case CanvasInstruction.BEGIN_GEOMETRY:E=j[1],it=j[3],E.getGeometry()?void 0===Z||intersects(Z,it.getExtent())?++u:u=j[2]+1:u=j[2],p&&(p.zIndex=j[4]);break;case CanvasInstruction.BEGIN_PATH:A>at&&(this.fill_(h),A=0),w>at&&(h.stroke(),w=0),A||w||(h.beginPath(),T=NaN,C=NaN),++u;break;case CanvasInstruction.CIRCLE:m=j[1];var M=d[m],O=d[m+1],R=d[m+2]-M,rt=d[m+3]-O,R=Math.sqrt(R*R+rt*rt);h.moveTo(M+R,O),h.arc(M,O,R,0,2*Math.PI,!0),++u;break;case CanvasInstruction.CLOSE_PATH:h.closePath(),++u;break;case CanvasInstruction.CUSTOM:m=j[1],f=j[2];rt=j[3];const vt=j[4],yt=j[5],N=(et.geometry=rt,et.feature=E,u in Q||(Q[u]=[]),Q[u]);yt?yt(d,m,f,2,N):(N[0]=d[m],N[1]=d[m+1],N.length=2),p&&(p.zIndex=j[6]),vt(N,et),++u;break;case CanvasInstruction.DRAW_IMAGE:m=j[1],f=j[2],I=j[3],x=j[4],g=j[5];let t=j[6];var st=j[7],nt=j[8],lt=j[9],M=j[10];let e=j[11];var ot=j[12];let a=j[13];_=j[14]||"declutter";const G=j[15];!I&&20<=j.length&&(v=j[19],y=j[20],S=j[21],b=j[22],O=this.drawLabelWithPointPlacement_(v,y,S,b),I=O.label,j[3]=I,R=j[23],x=(O.anchorX-R)*this.pixelRatio,j[4]=x,dt=j[24],g=(O.anchorY-dt)*this.pixelRatio,j[5]=g,t=I.height,j[6]=t,a=I.width,j[13]=a);let i;25<j.length&&(i=j[25]);let r,s,n,l=(n=17<j.length?(r=j[16],s=j[17],j[18]):(r=defaultPadding,s=!1),M&&tt?e+=$:M||tt||(e-=$),0);for(;m<f;m+=2)if(!(i&&i[l++]<a/this.pixelRatio)){var ht=this.calculateImageOrLabelDimensions_(I.width,I.height,d[m],d[m+1],a,t,x,g,nt,lt,e,ot,H,r,s||n,E),ct=[h,F,I,ht,st,s?K:null,n?V:null];if(c){let t,e,a;if(G){var pt=f-m;if(!G[pt]){G[pt]={args:ct,declutterMode:_};continue}var D=G[pt];t=D.args,e=D.declutterMode,delete G[pt],a=getDeclutterBox(t)}let i,r;!t||"declutter"===e&&c.collides(a)||(i=!0),"declutter"===_&&c.collides(ht.declutterBox)||(r=!0),"declutter"===e&&"declutter"===_&&(D=i&&r,i=D,r=D),i&&("none"!==e&&c.insert(a),this.replayImageOrLabel_.apply(this,t)),r&&("none"!==_&&c.insert(ht.declutterBox),this.replayImageOrLabel_.apply(this,ct))}else this.replayImageOrLabel_.apply(this,ct)}++u;break;case CanvasInstruction.DRAW_CHARS:var dt=j[1],ut=j[2],mt=j[3],ft=j[4],xt=(b=j[5],j[6]),B=j[7],gt=j[8],_t=(S=j[9],j[10]),Tt=(v=j[11],y=j[12],[j[13],j[13]]),P=(_=j[14]||"declutter",this.textStates[y]),W=P.font,X=[P.scale[0]*B,P.scale[1]*B];let o;W in this.widths_?o=this.widths_[W]:(o={},this.widths_[W]=o);P=lineStringLength(d,dt,ut,2),B=Math.abs(X[0])*measureAndCacheTextWidth(W,v,o);if(ft||B<=P){var ft=this.textStates[y].textAlign,P=(P-B)*horizontalTextAlign(v,ft),Y=drawTextOnPath(d,dt,ut,2,v,P,xt,Math.abs(X[0]),measureAndCacheTextWidth,W,o,tt?0:this.viewRotation_);t:if(Y){const z=[];let t,e,a,i,r;if(S)for(t=0,e=Y.length;t<e;++t){r=Y[t],a=r[4],i=this.createLabel(a,y,"",S),x=r[2]+(X[0]<0?-_t:_t),g=mt*i.height+2*(.5-mt)*_t*X[1]/X[0]-gt;var Ct=this.calculateImageOrLabelDimensions_(i.width,i.height,r[0],r[1],i.width,i.height,x,g,0,0,r[3],Tt,!1,defaultPadding,!1,E);if(c&&"declutter"===_&&c.collides(Ct.declutterBox))break t;z.push([h,F,i,Ct,1,null,null])}if(b)for(t=0,e=Y.length;t<e;++t){r=Y[t],a=r[4],i=this.createLabel(a,y,b,""),x=r[2],g=mt*i.height-gt;var It=this.calculateImageOrLabelDimensions_(i.width,i.height,r[0],r[1],i.width,i.height,x,g,0,0,r[3],Tt,!1,defaultPadding,!1,E);if(c&&"declutter"===_&&c.collides(It.declutterBox))break t;z.push([h,F,i,It,1,null,null])}c&&"none"!==_&&c.load(z.map(getDeclutterBox));for(let t=0,e=z.length;t<e;++t)this.replayImageOrLabel_.apply(this,z[t])}}++u;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==U){B=U(E=j[1],it,_);if(B)return B}++u;break;case CanvasInstruction.FILL:at?A++:this.fill_(h),++u;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(m=j[1],f=j[2],L=d[m],k=d[m+1],h.moveTo(L,k),T=L+.5|0,C=k+.5|0,m+=2;m<f;m+=2)q=(L=d[m])+.5|0,J=(k=d[m+1])+.5|0,m!=f-2&&q===T&&J===C||(h.lineTo(L,k),T=q,C=J);++u;break;case CanvasInstruction.SET_FILL_STYLE:K=j,this.alignAndScaleFill_=j[2],A&&(this.fill_(h),A=0,w&&(h.stroke(),w=0)),h.fillStyle=j[1],++u;break;case CanvasInstruction.SET_STROKE_STYLE:V=j,w&&(h.stroke(),w=0),this.setStrokeStyle_(h,j),++u;break;case CanvasInstruction.STROKE:at?w++:h.stroke(),++u;break;default:++u}}A&&this.fill_(h),w&&h.stroke()}execute(t,e,a,i,r,s){this.viewRotation_=i,this.execute_(t,e,a,this.instructions,r,void 0,void 0,s)}executeHitDetection(t,e,a,i,r){return this.viewRotation_=a,this.execute_(t,[t.canvas.width,t.canvas.height],e,this.hitDetectionInstructions,!0,i,r)}}export default Executor;