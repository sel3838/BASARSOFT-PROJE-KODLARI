import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasLayerRenderer,{canvasPool}from"./Layer.js";import ExecutorGroup,{ALL,DECLUTTER,NON_DECLUTTER}from"../../render/canvas/ExecutorGroup.js";import RenderEventType from"../../render/EventType.js";import ViewHint from"../../ViewHint.js";import{HIT_DETECT_RESOLUTION,createHitDetectionImageData,hitDetect}from"../../render/canvas/hitdetect.js";import{buffer,containsExtent,createEmpty,getHeight,getWidth,intersects as intersectsExtent,wrapX as wrapExtentX}from"../../extent.js";import{createCanvasContext2D,releaseCanvas}from"../../dom.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{equals}from"../../array.js";import{fromUserExtent,getTransformFromProjections,getUserProjection,toUserExtent,toUserResolution}from"../../proj.js";import{getUid}from"../../util.js";import{wrapX as wrapCoordinateX}from"../../coordinate.js";class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipped_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.wrappedRenderedExtent_=createEmpty(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(t,r,n){var e=r.extent,i=r.viewState,a=i.center,s=i.resolution;const o=i.projection;var d=i.rotation,i=o.getExtent();const h=this.getLayer().getSource();var l=this.getLayer().getDeclutter(),c=r.pixelRatio,u=r.viewHints,p=!(u[ViewHint.ANIMATING]||u[ViewHint.INTERACTING]),g=this.context,_=Math.round(getWidth(e)/s*c),m=Math.round(getHeight(e)/s*c),u=h.getWrapX()&&o.canWrapX(),x=u?getWidth(i):null,E=u?Math.ceil((e[2]-i[2])/x)+1:1;let R=u?Math.floor((e[0]-i[0])/x):0;do{let e=this.getRenderTransform(a,s,0,c,_,m,R*x);r.declutter&&(e=e.slice(0)),t.execute(g,[g.canvas.width,g.canvas.height],e,d,p,void 0===n?ALL:n?DECLUTTER:NON_DECLUTTER,n?l&&r.declutter[l]:void 0)}while(++R<E)}setDrawContext_(){1!==this.opacity_&&(this.targetContext_=this.context,this.context=createCanvasContext2D(this.context.canvas.width,this.context.canvas.height,canvasPool))}resetDrawContext_(){var e;1!==this.opacity_&&(e=this.targetContext_.globalAlpha,this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=e,releaseCanvas(this.context),canvasPool.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null)}renderDeclutter(e){this.replayGroup_&&this.getLayer().getDeclutter()&&this.renderWorlds(this.replayGroup_,e,!0)}renderDeferredInternal(e){this.replayGroup_&&(this.replayGroup_.renderDeferred(),this.clipped_&&this.context.restore(),this.resetDrawContext_())}renderFrame(e,t){var r=e.layerStatesArray[e.layerIndex],n=(this.opacity_=r.opacity,e.viewState);this.prepareContainer(e,t);const i=this.context,a=this.replayGroup_;let s=a&&!a.isEmpty();if(!s&&!(this.getLayer().hasListener(RenderEventType.PRERENDER)||this.getLayer().hasListener(RenderEventType.POSTRENDER)))return null;this.setDrawContext_(),this.preRender(i,e);t=n.projection;return this.clipped_=!1,s&&r.extent&&this.clipping&&(r=fromUserExtent(r.extent,t),s=intersectsExtent(r,e.extent),this.clipped_=s&&!containsExtent(r,e.extent),this.clipped_&&this.clipUnrotated(i,e,r)),s&&this.renderWorlds(a,e,!this.getLayer().getDeclutter()&&void 0),!e.declutter&&this.clipped_&&i.restore(),this.postRender(i,e),this.renderedRotation_!==n.rotation&&(this.renderedRotation_=n.rotation,this.hitDetectionImageData_=null),e.declutter||this.resetDrawContext_(),this.container}getFeatures(_){return new Promise(e=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){var t=this.frameState.size.slice(),n=this.renderedCenter_,i=this.renderedResolution_,a=this.renderedRotation_;const c=this.renderedProjection_;var s=this.wrappedRenderedExtent_;const u=this.getLayer(),p=[];var o=t[0]*HIT_DETECT_RESOLUTION,d=t[1]*HIT_DETECT_RESOLUTION;p.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,0).slice());const g=u.getSource();var h=c.getExtent();if(g.getWrapX()&&c.canWrapX()&&!containsExtent(h,s)){let e=s[0];var l=getWidth(h);let t=0,r;for(;e<h[0];)--t,r=l*t,p.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,r).slice()),e+=l;for(t=0,e=s[2];e>h[2];)++t,r=l*t,p.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,r).slice()),e-=l}var r=getUserProjection();this.hitDetectionImageData_=createHitDetectionImageData(t,p,this.renderedFeatures_,u.getStyleFunction(),s,i,a,getSquaredRenderTolerance(i,this.renderedPixelRatio_),r?c:null)}e(hitDetect(_,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(r,n,i,a,s){if(this.replayGroup_){const o=n.viewState.resolution,d=n.viewState.rotation,h=this.getLayer(),l={},c=function(e,t,r){var n=getUid(e);const i=l[n];if(i){if(!0!==i&&r<i.distanceSq){if(0===r)return l[n]=!0,s.splice(s.lastIndexOf(i),1),a(e,h,t);i.geometry=t,i.distanceSq=r}}else{if(0===r)return l[n]=!0,a(e,h,t);s.push(l[n]={feature:e,layer:h,geometry:t,distanceSq:r,callback:a})}};let t;const e=[this.replayGroup_],u=this.getLayer().getDeclutter();return e.some(e=>t=e.forEachFeatureAtCoordinate(r,o,d,i,c,u&&n.declutter[u]?n.declutter[u].all().map(e=>e.value):null)),t}}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const i=this.getLayer(),r=i.getSource();if(!r)return!1;var t=e.viewHints[ViewHint.ANIMATING],n=e.viewHints[ViewHint.INTERACTING],a=i.getUpdateWhileAnimating(),s=i.getUpdateWhileInteracting();if(this.ready&&!a&&t||!s&&n)return this.animatingOrInteracting_=!0;this.animatingOrInteracting_=!1;a=e.extent;const o=e.viewState,d=o.projection,h=o.resolution;t=e.pixelRatio,s=i.getRevision(),n=i.getRenderBuffer();let l=i.getRenderOrder();void 0===l&&(l=defaultRenderOrder);var c=o.center.slice();const u=buffer(a,n*h);a=u.slice();const p=[u.slice()];var g,n=d.getExtent();if(r.getWrapX()&&d.canWrapX()&&!containsExtent(n,e.extent)&&(T=getWidth(n),g=Math.max(getWidth(u)/2,T),u[0]=n[0]-g,u[2]=n[2]+g,wrapCoordinateX(c,d),(g=wrapExtentX(p[0],d))[0]<n[0]&&g[2]<n[2]?p.push([g[0]+T,g[1],g[2]+T,g[3]]):g[0]>n[0]&&g[2]>n[2]&&p.push([g[0]-T,g[1],g[2]-T,g[3]])),this.ready&&this.renderedResolution_==h&&this.renderedRevision_==s&&this.renderedRenderOrder_==l&&this.renderedFrameDeclutter_===!!e.declutter&&containsExtent(this.wrappedRenderedExtent_,u))return equals(this.renderedExtent_,a)||(this.hitDetectionImageData_=null,this.renderedExtent_=a),this.renderedCenter_=c,!(this.replayGroupChanged=!1);this.replayGroup_=null;const _=new CanvasBuilderGroup(getRenderTolerance(h,t),u,h,t);var m=getUserProjection();let x;if(m){for(let e=0,t=p.length;e<t;++e){const u=p[e],f=toUserExtent(u,d);r.loadFeatures(f,toUserResolution(h,d),m)}x=getTransformFromProjections(m,d)}else for(let e=0,t=p.length;e<t;++e)r.loadFeatures(p[e],h,d);const E=getSquaredRenderTolerance(h,t);let R=!0;var y=(e,t)=>{let r;const n=e.getStyleFunction()||i.getStyleFunction();(r=n?n(e,h):r)&&(e=this.renderFeature(e,E,r,_,x,this.getLayer().getDeclutter(),t),R=R&&!e)};const f=toUserExtent(u,d),v=r.getFeaturesInExtent(f);l&&v.sort(l);for(let e=0,t=v.length;e<t;++e)y(v[e],e);this.renderedFeatures_=v,this.ready=R;var n=_.finish(),T=new ExecutorGroup(u,h,t,r.getOverlaps(),n,i.getRenderBuffer(),!!e.declutter);return this.renderedResolution_=h,this.renderedRevision_=s,this.renderedRenderOrder_=l,this.renderedFrameDeclutter_=!!e.declutter,this.renderedExtent_=a,this.wrappedRenderedExtent_=u,this.renderedCenter_=c,this.renderedProjection_=d,this.renderedPixelRatio_=t,this.replayGroup_=T,this.hitDetectionImageData_=null,this.replayGroupChanged=!0}renderFeature(r,n,i,a,s,o,d){if(!i)return!1;let h=!1;if(Array.isArray(i))for(let e=0,t=i.length;e<t;++e)h=renderFeature(a,r,i[e],n,this.boundHandleStyleImageChange_,s,o,d)||h;else h=renderFeature(a,r,i,n,this.boundHandleStyleImageChange_,s,o,d);return h}}export default CanvasVectorLayerRenderer;