import Disposable from"../Disposable.js";import{TRUE}from"../functions.js";import{abstract}from"../util.js";import{compose as composeTransform,makeInverse}from"../transform.js";import{getWidth}from"../extent.js";import{shared as iconImageCache}from"../style/IconImageCache.js";import{inView}from"../layer/Layer.js";import{wrapX}from"../coordinate.js";class MapRenderer extends Disposable{constructor(e){super(),this.map_=e}dispatchRenderEvent(e,r){abstract()}calculateMatrices2D(e){var r=e.viewState,t=e.coordinateToPixelTransform,a=e.pixelToCoordinateTransform;composeTransform(t,e.size[0]/2,e.size[1]/2,1/r.resolution,-1/r.resolution,-r.rotation,-r.center[0],-r.center[1]),makeInverse(a,t)}forEachFeatureAtCoordinate(t,a,o,e,n,s,i,c){let l;var m=a.viewState;function p(e,r,t,a){return n.call(s,r,e?t:null,a)}const r=m.projection;var h=wrapX(t.slice(),r);const f=[[0,0]];r.canWrapX()&&e&&(e=r.getExtent(),e=getWidth(e),f.push([-e,0],[e,0]));var d=a.layerStatesArray,u=d.length;const g=[],C=[];for(let r=0;r<f.length;r++)for(let e=u-1;0<=e;--e){var v=d[e];const E=v.layer;if(E.hasRenderer()&&inView(v,m)&&i.call(c,E)){const I=E.getRenderer(),j=E.getSource();if(I&&j){var x=j.getWrapX()?h:t;const n=p.bind(null,v.managed);C[0]=x[0]+f[r][0],C[1]=x[1]+f[r][1],l=I.forEachFeatureAtCoordinate(C,a,o,n,g)}if(l)return l}}if(0!==g.length){const b=1/g.length;return g.forEach((e,r)=>e.distanceSq+=r*b),g.sort((e,r)=>e.distanceSq-r.distanceSq),g.some(e=>l=e.callback(e.feature,e.layer,e.geometry)),l}}hasFeatureAtCoordinate(e,r,t,a,o,n){return void 0!==this.forEachFeatureAtCoordinate(e,r,t,a,TRUE,this,o,n)}getMap(){return this.map_}renderFrame(e){abstract()}scheduleExpireIconCache(e){iconImageCache.canExpireCache()&&e.postRenderFunctions.push(expireIconCache)}}function expireIconCache(e,r){iconImageCache.expire()}export default MapRenderer;