import BaseLayer from"./Base.js";import EventType from"../events/EventType.js";import LayerProperty from"./Property.js";import RenderEventType from"../render/EventType.js";import View from"../View.js";import{assert}from"../asserts.js";import{intersects}from"../extent.js";import{listen,unlistenByKey}from"../events.js";class Layer extends BaseLayer{constructor(e){const t=Object.assign({},e);delete t.source,super(t),this.on,this.once,this.un,this.mapPrecomposeKey_=null,this.mapRenderKey_=null,this.sourceChangeKey_=null,this.renderer_=null,this.sourceReady_=!1,this.rendered=!1,e.render&&(this.render=e.render),e.map&&this.setMap(e.map),this.addChangeListener(LayerProperty.SOURCE,this.handleSourcePropertyChange_);e=e.source||null;this.setSource(e)}getLayersArray(e){return(e=e||[]).push(this),e}getLayerStatesArray(e){return(e=e||[]).push(this.getLayerState()),e}getSource(){return this.get(LayerProperty.SOURCE)||null}getRenderSource(){return this.getSource()}getSourceState(){const e=this.getSource();return e?e.getState():"undefined"}handleSourceChange_(){this.changed(),this.sourceReady_||"ready"!==this.getSource().getState()||(this.sourceReady_=!0,this.dispatchEvent("sourceready"))}handleSourcePropertyChange_(){this.sourceChangeKey_&&(unlistenByKey(this.sourceChangeKey_),this.sourceChangeKey_=null),this.sourceReady_=!1;const e=this.getSource();e&&(this.sourceChangeKey_=listen(e,EventType.CHANGE,this.handleSourceChange_,this),"ready"===e.getState()&&(this.sourceReady_=!0,setTimeout(()=>{this.dispatchEvent("sourceready")},0))),this.changed()}getFeatures(e){return this.renderer_?this.renderer_.getFeatures(e):Promise.resolve([])}getData(e){return this.renderer_&&this.rendered?this.renderer_.getData(e):null}isVisible(e){let t;const r=this.getMapInternal();!e&&r&&(e=r.getView()),!(t=e instanceof View?{viewState:e.getState(),extent:e.calculateExtent()}:e).layerStatesArray&&r&&(t.layerStatesArray=r.getLayerGroup().getLayerStatesArray());let s;s=t.layerStatesArray?t.layerStatesArray.find(e=>e.layer===this):this.getLayerState();e=this.getExtent();return inView(s,t.viewState)&&(!e||intersects(e,t.extent))}getAttributions(e){if(!this.isVisible(e))return[];let t;const r=this.getSource();if(!(t=r?r.getAttributions():t))return[];e=e instanceof View?e.getViewStateAndExtent():e;let s=t(e);return s=Array.isArray(s)?s:[s]}render(e,t){const r=this.getRenderer();return r.prepareFrame(e)?(this.rendered=!0,r.renderFrame(e,t)):null}unrender(){this.rendered=!1}getDeclutter(){}renderDeclutter(e,t){}renderDeferred(e){const t=this.getRenderer();t&&t.renderDeferred(e)}setMapInternal(e){e||this.unrender(),this.set(LayerProperty.MAP,e)}getMapInternal(){return this.get(LayerProperty.MAP)}setMap(e){this.mapPrecomposeKey_&&(unlistenByKey(this.mapPrecomposeKey_),this.mapPrecomposeKey_=null),e||this.changed(),this.mapRenderKey_&&(unlistenByKey(this.mapRenderKey_),this.mapRenderKey_=null),e&&(this.mapPrecomposeKey_=listen(e,RenderEventType.PRECOMPOSE,function(e){const t=e.frameState.layerStatesArray,r=this.getLayerState(!1);assert(!t.some(function(e){return e.layer===r.layer}),"A layer can only be added to the map once. Use either `layer.setMap()` or `map.addLayer()`, not both."),t.push(r)},this),this.mapRenderKey_=listen(this,EventType.CHANGE,e.render,e),this.changed())}setSource(e){this.set(LayerProperty.SOURCE,e)}getRenderer(){return this.renderer_||(this.renderer_=this.createRenderer()),this.renderer_}hasRenderer(){return!!this.renderer_}createRenderer(){return null}disposeInternal(){this.renderer_&&(this.renderer_.dispose(),delete this.renderer_),this.setSource(null),super.disposeInternal()}}function inView(e,t){if(!e.visible)return!1;var r=t.resolution;if(r<e.minResolution||r>=e.maxResolution)return!1;r=t.zoom;return r>e.minZoom&&r<=e.maxZoom}export default Layer;export{inView};