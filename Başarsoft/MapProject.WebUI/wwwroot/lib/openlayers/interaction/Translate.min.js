import Collection from"../Collection.js";import Event from"../events/Event.js";import Feature from"../Feature.js";import InteractionProperty from"./Property.js";import PointerInteraction from"./Pointer.js";import{TRUE}from"../functions.js";import{always}from"../events/condition.js";import{fromUserCoordinate,getUserProjection}from"../proj.js";const TranslateEventType={TRANSLATESTART:"translatestart",TRANSLATING:"translating",TRANSLATEEND:"translateend"};class TranslateEvent extends Event{constructor(t,e,r,a,s){super(t),this.features=e,this.coordinate=r,this.startCoordinate=a,this.mapBrowserEvent=s}}class Translate extends PointerInteraction{constructor(t){super(t=t||{}),this.on,this.once,this.un,this.lastCoordinate_=null,this.startCoordinate_=null,this.features_=void 0!==t.features?t.features:null;let e;if(t.layers&&!this.features_)if("function"==typeof t.layers)e=t.layers;else{const r=t.layers;e=function(t){return r.includes(t)}}else e=TRUE;this.layerFilter_=e,this.filter_=t.filter&&!this.features_?t.filter:TRUE,this.hitTolerance_=t.hitTolerance||0,this.condition_=t.condition||always,this.lastFeature_=null,this.addChangeListener(InteractionProperty.ACTIVE,this.handleActiveChanged_)}handleDownEvent(t){return!(!t.originalEvent||!this.condition_(t))&&(this.lastFeature_=this.featuresAtPixel_(t.pixel,t.map),!(this.lastCoordinate_||!this.lastFeature_)&&(this.startCoordinate_=t.coordinate,this.lastCoordinate_=t.coordinate,this.handleMoveEvent(t),e=this.features_||new Collection([this.lastFeature_]),this.dispatchEvent(new TranslateEvent(TranslateEventType.TRANSLATESTART,e,t.coordinate,this.startCoordinate_,t)),!0));var e}handleUpEvent(t){var e;return!!this.lastCoordinate_&&(this.lastCoordinate_=null,this.handleMoveEvent(t),e=this.features_||new Collection([this.lastFeature_]),this.dispatchEvent(new TranslateEvent(TranslateEventType.TRANSLATEEND,e,t.coordinate,this.startCoordinate_,t)),!(this.startCoordinate_=null))}handleDragEvent(t){if(this.lastCoordinate_){var e=t.coordinate;const s=t.map.getView().getProjection();var r=fromUserCoordinate(e,s),a=fromUserCoordinate(this.lastCoordinate_,s);const i=r[0]-a[0],n=r[1]-a[1],o=this.features_||new Collection([this.lastFeature_]),l=getUserProjection();o.forEach(function(t){const e=t.getGeometry();l?(e.transform(l,s),e.translate(i,n),e.transform(s,l)):e.translate(i,n),t.setGeometry(e)}),this.lastCoordinate_=e,this.dispatchEvent(new TranslateEvent(TranslateEventType.TRANSLATING,o,e,this.startCoordinate_,t))}}handleMoveEvent(t){const e=t.map.getViewport();this.featuresAtPixel_(t.pixel,t.map)?(e.classList.remove(this.lastCoordinate_?"ol-grab":"ol-grabbing"),e.classList.add(this.lastCoordinate_?"ol-grabbing":"ol-grab")):e.classList.remove("ol-grab","ol-grabbing")}featuresAtPixel_(t,e){return e.forEachFeatureAtPixel(t,(t,e)=>{if(t instanceof Feature&&this.filter_(t,e)&&(!this.features_||this.features_.getArray().includes(t)))return t},{layerFilter:this.layerFilter_,hitTolerance:this.hitTolerance_})}getHitTolerance(){return this.hitTolerance_}setHitTolerance(t){this.hitTolerance_=t}setMap(t){var e=this.getMap();super.setMap(t),this.updateState_(e)}handleActiveChanged_(){this.updateState_(null)}updateState_(t){let e=this.getMap();var r=this.getActive();if((!e||!r)&&(e=e||t)){const a=e.getViewport();a.classList.remove("ol-grab","ol-grabbing")}}}export default Translate;export{TranslateEvent};