import EventType from"../events/EventType.js";import Interaction from"./Interaction.js";import MapEventType from"../MapEventType.js";import{listen,unlistenByKey}from"../events.js";import{toFixed}from"../math.js";function to5(t){return toFixed(t,5)}function readNumber(t){return parseFloat(t)}function writeNumber(t){return to5(t).toString()}function differentNumber(t,e){return!isNaN(t)&&t!==readNumber(writeNumber(e))}function differentArray(t,e){return differentNumber(t[0],e[0])||differentNumber(t[1],e[1])}class Link extends Interaction{constructor(t){super(),t=Object.assign({animate:!0,params:["x","y","z","r","l"],replace:!1,prefix:""},t||{});let e;e=!0===t.animate?{duration:250}:t.animate||null,this.animationOptions_=e,this.params_=t.params.reduce((t,e)=>(t[e]=!0,t),{}),this.replace_=t.replace,this.prefix_=t.prefix,this.listenerKeys_=[],this.initial_=!0,this.updateState_=this.updateState_.bind(this),this.trackedCallbacks_={},this.trackedValues_={}}getParamName_(t){return this.prefix_?this.prefix_+t:t}get_(t,e){return t.get(this.getParamName_(e))}set_(t,e,i){e in this.params_&&t.set(this.getParamName_(e),i)}delete_(t,e){e in this.params_&&t.delete(this.getParamName_(e))}setMap(t){var e=this.getMap();super.setMap(t),t!==e&&(e&&this.unregisterListeners_(e),t&&(this.initial_=!0,this.updateState_(),this.registerListeners_(t)))}registerListeners_(t){this.listenerKeys_.push(listen(t,MapEventType.MOVEEND,this.updateUrl_,this),listen(t.getLayerGroup(),EventType.CHANGE,this.updateUrl_,this),listen(t,"change:layergroup",this.handleChangeLayerGroup_,this)),this.replace_||addEventListener("popstate",this.updateState_)}unregisterListeners_(t){for(let t=0,e=this.listenerKeys_.length;t<e;++t)unlistenByKey(this.listenerKeys_[t]);this.listenerKeys_.length=0,this.replace_||removeEventListener("popstate",this.updateState_);var e=new URL(window.location.href),i=e.searchParams;this.delete_(i,"x"),this.delete_(i,"y"),this.delete_(i,"z"),this.delete_(i,"r"),this.delete_(i,"l"),window.history.replaceState(null,"",e)}handleChangeLayerGroup_(){var t=this.getMap();t&&(this.unregisterListeners_(t),this.registerListeners_(t),this.initial_=!0,this.updateUrl_())}updateState_(){const e=new URL(window.location.href).searchParams;for(const h in this.trackedCallbacks_){var t=e.get(h);h in this.trackedCallbacks_&&t!==this.trackedValues_[h]&&(this.trackedValues_[h]=t,this.trackedCallbacks_[h](t))}const i=this.getMap();if(i){const o=i.getView();if(o){let t=!1;const l={};var s=readNumber(this.get_(e,"z")),s=("z"in this.params_&&differentNumber(s,o.getZoom())&&(t=!0,l.zoom=s),readNumber(this.get_(e,"r"))),s=("r"in this.params_&&differentNumber(s,o.getRotation())&&(t=!0,l.rotation=s),[readNumber(this.get_(e,"x")),readNumber(this.get_(e,"y"))]),r=(("x"in this.params_||"y"in this.params_)&&differentArray(s,o.getCenter())&&(t=!0,l.center=s),t&&(!this.initial_&&this.animationOptions_?o.animate(Object.assign(l,this.animationOptions_)):(l.center&&o.setCenter(l.center),"zoom"in l&&o.setZoom(l.zoom),"rotation"in l&&o.setRotation(l.rotation))),i.getAllLayers()),a=this.get_(e,"l");if("l"in this.params_&&a&&a.length===r.length)for(let t=0,e=r.length;t<e;++t){var n=parseInt(a[t]);if(!isNaN(n)){n=Boolean(n);const _=r[t];_.getVisible()!==n&&_.setVisible(n)}}}}}track(t,e){this.trackedCallbacks_[t]=e;const i=new URL(window.location.href).searchParams;e=i.get(t);return this.trackedValues_[t]=e}update(t,e){var i=new URL(window.location.href);const s=i.searchParams;null===e?s.delete(t):s.set(t,e),t in this.trackedValues_&&(this.trackedValues_[t]=e),this.updateHistory_(i)}updateUrl_(){const t=this.getMap();if(t){const n=t.getView();if(n){var e=n.getCenter(),i=n.getZoom(),s=n.getRotation();const h=t.getAllLayers(),o=new Array(h.length);for(let t=0,e=h.length;t<e;++t)o[t]=h[t].getVisible()?"1":"0";var r=new URL(window.location.href),a=r.searchParams;this.set_(a,"x",writeNumber(e[0])),this.set_(a,"y",writeNumber(e[1])),this.set_(a,"z",writeNumber(i)),this.set_(a,"r",writeNumber(s)),this.set_(a,"l",o.join("")),this.updateHistory_(r),this.initial_=!1}}}updateHistory_(t){t.href!==window.location.href&&(this.initial_||this.replace_?window.history.replaceState(history.state,"",t):window.history.pushState(null,"",t))}}export default Link;