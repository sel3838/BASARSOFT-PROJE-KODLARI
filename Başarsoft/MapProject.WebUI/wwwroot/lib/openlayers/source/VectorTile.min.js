import EventType from"../events/EventType.js";import Tile from"../VectorTile.js";import TileCache from"../TileCache.js";import TileGrid from"../tilegrid/TileGrid.js";import TileState from"../TileState.js";import UrlTile from"./UrlTile.js";import VectorRenderTile from"../VectorRenderTile.js";import{DEFAULT_MAX_ZOOM}from"../tilegrid/common.js";import{buffer as bufferExtent,getIntersection,intersects}from"../extent.js";import{createXYZ,extentFromProjection}from"../tilegrid.js";import{fromKey,getCacheKeyForTileKey,getKeyZXY}from"../tilecoord.js";import{isEmpty}from"../obj.js";import{loadFeaturesXhr}from"../featureloader.js";import{toSize}from"../size.js";class VectorTile extends UrlTile{constructor(e){var t=e.projection||"EPSG:3857",i=e.extent||extentFromProjection(t),i=e.tileGrid||createXYZ({extent:i,maxResolution:e.maxResolution,maxZoom:void 0!==e.maxZoom?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,opaque:!1,projection:t,state:e.state,tileGrid:i,tileLoadFunction:e.tileLoadFunction||defaultLoadFunction,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition,zDirection:void 0===e.zDirection?1:e.zDirection}),this.format_=e.format||null,this.sourceTileCache=new TileCache(this.tileCache.highWaterMark),this.overlaps_=null==e.overlaps||e.overlaps,this.tileClass=e.tileClass||Tile,this.tileGrids_={}}getFeaturesInExtent(a){const c=[],e=this.tileCache;if(0===e.getCount())return c;const t=fromKey(e.peekFirstKey())[0],u=this.tileGrid;return e.forEach(function(e){if(e.tileCoord[0]===t&&e.getState()===TileState.LOADED){var i=e.getSourceTiles();for(let e=0,t=i.length;e<t;++e){const l=i[e];var r=l.tileCoord;if(intersects(a,u.getTileCoordExtent(r))){var o=l.getFeatures();if(o)for(let e=0,t=o.length;e<t;++e){const s=o[e],n=s.getGeometry();intersects(a,n.getExtent())&&c.push(s)}}}}}),c}getOverlaps(){return this.overlaps_}clear(){this.tileCache.clear(),this.sourceTileCache.clear()}expireCache(e,t){const o=this.getTileCacheForProjection(e);var i=Object.keys(t).reduce((i,e)=>{e=getCacheKeyForTileKey(e),e=o.peek(e);if(e){const r=e.sourceTiles;for(let e=0,t=r.length;e<t;++e)i[r[e].getKey()]=!0}return i},{});super.expireCache(e,t),this.sourceTileCache.expireCache(i)}getSourceTiles(l,s,n){if(n.getState()===TileState.IDLE){n.setState(TileState.LOADING);var e=n.wrappedTileCoord;const r=this.getTileGridForProjection(s);var t=r.getTileCoordExtent(e),e=e[0],e=r.getResolution(e);bufferExtent(t,-e,t);const a=this.tileGrid;var i=a.getExtent(),i=(i&&getIntersection(t,i,t),a.getZForResolution(e,this.zDirection));a.forEachTileCoord(t,i,e=>{var t=this.tileUrlFunction(e,l,s);const i=this.sourceTileCache.containsKey(t)?this.sourceTileCache.get(t):new this.tileClass(e,t?TileState.IDLE:TileState.EMPTY,t,this.format_,this.tileLoadFunction);n.sourceTiles.push(i);var r=i.getState();if(r<TileState.LOADED){const o=e=>{this.handleTileChange(e);var t,e=i.getState();e!==TileState.LOADED&&e!==TileState.ERROR||((t=i.getKey())in n.errorTileKeys?i.getState()===TileState.LOADED&&delete n.errorTileKeys[t]:n.loadingSourceTiles--,e===TileState.ERROR?n.errorTileKeys[t]=!0:i.removeEventListener(EventType.CHANGE,o),0===n.loadingSourceTiles&&n.setState(isEmpty(n.errorTileKeys)?TileState.LOADED:TileState.ERROR))};i.addEventListener(EventType.CHANGE,o),n.loadingSourceTiles++}r===TileState.IDLE&&(i.extent=a.getTileCoordExtent(e),i.projection=s,i.resolution=a.getResolution(e[0]),this.sourceTileCache.set(t,i),i.load())}),n.loadingSourceTiles||n.setState(n.sourceTiles.some(e=>e.getState()===TileState.ERROR)?TileState.ERROR:TileState.LOADED)}return n.sourceTiles}getTile(e,t,i,r,o){var l=getKeyZXY(e,t,i),s=this.getKey();let n;if(this.tileCache.containsKey(l)&&(n=this.tileCache.get(l)).key===s)return n;t=[e,t,i];let a=this.getTileCoordForTileUrlFunction(t,o);i=this.getTileGrid().getExtent();const c=this.getTileGridForProjection(o);a&&i&&(h=c.getTileCoordExtent(a),bufferExtent(h,-c.getResolution(e),h),intersects(i,h)||(a=null));let u=!0;if(null!==a){const g=this.tileGrid;var i=c.getResolution(e),h=g.getZForResolution(i,1),e=c.getTileCoordExtent(a);bufferExtent(e,-i,e),g.forEachTileCoord(e,h,e=>{u=u&&!this.tileUrlFunction(e,r,o)})}const T=new VectorRenderTile(t,u?TileState.EMPTY:TileState.IDLE,a,this.getSourceTiles.bind(this,r,o));return T.key=s,n?(T.interimTile=n,T.refreshInterimChain(),this.tileCache.replace(l,T)):this.tileCache.set(l,T),T}getTileGridForProjection(e){e=e.getCode();let t=this.tileGrids_[e];if(!t){const r=this.tileGrid,o=r.getResolutions().slice(),l=o.map(function(e,t){return r.getOrigin(t)}),s=o.map(function(e,t){return r.getTileSize(t)});var i=DEFAULT_MAX_ZOOM+1;for(let e=o.length;e<i;++e)o.push(o[e-1]/2),l.push(l[e-1]),s.push(s[e-1]);t=new TileGrid({extent:r.getExtent(),origins:l,resolutions:o,tileSizes:s}),this.tileGrids_[e]=t}return t}getTilePixelRatio(e){return e}getTilePixelSize(e,t,i){const r=this.getTileGridForProjection(i);i=toSize(r.getTileSize(e),this.tmpSize);return[Math.round(i[0]*t),Math.round(i[1]*t)]}updateCacheSize(e,t){super.updateCacheSize(2*e,t),this.sourceTileCache.highWaterMark=this.getTileCacheForProjection(t).highWaterMark}}export default VectorTile;function defaultLoadFunction(r,o){r.setLoader(function(e,t,i){loadFeaturesXhr(o,r.getFormat(),e,t,i,r.onLoad.bind(r),r.onError.bind(r))})}export{defaultLoadFunction};