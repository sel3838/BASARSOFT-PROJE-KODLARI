import TileImage from"./TileImage.js";import{appendParams}from"../uri.js";import{containsExtent}from"../extent.js";import{createFromCapabilitiesMatrixSet}from"../tilegrid/WMTS.js";import{createFromTileUrlFunctions,expandUrl}from"../tileurlfunction.js";import{equivalent,get as getProjection,transformExtent}from"../proj.js";class WMTS extends TileImage{constructor(e){var t=void 0!==e.requestEncoding?e.requestEncoding:"KVP",i=e.tileGrid;let r=e.urls;void 0===r&&void 0!==e.url&&(r=expandUrl(e.url)),super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:i,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:e.tilePixelRatio,urls:r,wrapX:void 0!==e.wrapX&&e.wrapX,transition:e.transition,zDirection:e.zDirection}),this.version_=void 0!==e.version?e.version:"1.0.0",this.format_=void 0!==e.format?e.format:"image/jpeg",this.dimensions_=void 0!==e.dimensions?e.dimensions:{},this.layer_=e.layer,this.matrixSet_=e.matrixSet,this.style_=e.style,this.requestEncoding_=t,this.setKey(this.getKeyForDimensions_()),r&&0<r.length&&(this.tileUrlFunction=createFromTileUrlFunctions(r.map(this.createFromWMTSTemplate.bind(this))))}setUrls(e){var t=(this.urls=e).join("\n");this.setTileUrlFunction(createFromTileUrlFunctions(e.map(this.createFromWMTSTemplate.bind(this))),t)}getDimensions(){return this.dimensions_}getFormat(){return this.format_}getLayer(){return this.layer_}getMatrixSet(){return this.matrixSet_}getRequestEncoding(){return this.requestEncoding_}getStyle(){return this.style_}getVersion(){return this.version_}getKeyForDimensions_(){const e=this.urls?this.urls.slice(0):[];for(const t in this.dimensions_)e.push(t+"-"+this.dimensions_[t]);return e.join("/")}updateDimensions(e){Object.assign(this.dimensions_,e),this.setKey(this.getKeyForDimensions_())}createFromWMTSTemplate(n){const o=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_},s=("KVP"==o&&Object.assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),n="KVP"==o?appendParams(n,i):n.replace(/\{(\w+?)\}/g,function(e,t){return t.toLowerCase()in i?i[t.toLowerCase()]:e}),this.tileGrid),a=this.dimensions_;return function(t,e,i){if(t){const r={TileMatrix:s.getMatrixId(t[0]),TileCol:t[1],TileRow:t[2]};Object.assign(r,a);let e=n;return e="KVP"==o?appendParams(e,r):e.replace(/\{(\w+?)\}/g,function(e,t){return r[t]})}}}}export default WMTS;function optionsFromCapabilities(e,n){const t=e.Contents.Layer,i=t?.find(function(e){return e.Identifier==n.layer});if(!i)return null;const o=e.Contents.TileMatrixSet;let r;(r=1<i.TileMatrixSetLink.length?"projection"in n?i.TileMatrixSetLink.findIndex(function(t){var e=o.find(function(e){return e.Identifier==t.TileMatrixSet}).SupportedCRS,i=getProjection(e),r=getProjection(n.projection);return i&&r?equivalent(i,r):e==n.projection}):i.TileMatrixSetLink.findIndex(function(e){return e.TileMatrixSet==n.matrixSet}):0)<0&&(r=0);const s=i.TileMatrixSetLink[r].TileMatrixSet;var a=i.TileMatrixSetLink[r].TileMatrixSetLimits;let l=i.Format[0];"format"in n&&(l=n.format),(r=i.Style.findIndex(function(e){return"style"in n?e.Title==n.style:e.isDefault}))<0&&(r=0);var c=i.Style[r].Identifier;const u={},d=("Dimension"in i&&i.Dimension.forEach(function(e,t,i){var r=e.Identifier;let n=e.Default;void 0===n&&(n=e.Value[0]),u[r]=n}),e.Contents.TileMatrixSet),m=d.find(function(e){return e.Identifier==s});let p;var f=m.SupportedCRS;f&&(p=getProjection(f)),"projection"in n&&(!(f=getProjection(n.projection))||p&&!equivalent(f,p)||(p=f));let h=!1;f="ne"==p.getAxisOrientation().substr(0,2);let T=m.TileMatrix[0],g={MinTileCol:0,MinTileRow:0,MaxTileCol:T.MatrixWidth-1,MaxTileRow:T.MatrixHeight-1};a&&(g=a[a.length-1],(x=m.TileMatrix.find(e=>e.Identifier===g.TileMatrix||m.Identifier+":"+e.Identifier===g.TileMatrix))&&(T=x));var x=28e-5*T.ScaleDenominator/p.getMetersPerUnit(),S=f?[T.TopLeftCorner[1],T.TopLeftCorner[0]]:T.TopLeftCorner,M=T.TileWidth*x,x=T.TileHeight*x;let j=m.BoundingBox,v=(j&&f&&(j=[j[1],j[0],j[3],j[2]]),[S[0]+M*g.MinTileCol,S[1]-x*(1+g.MaxTileRow),S[0]+M*(1+g.MaxTileCol),S[1]-x*g.MinTileRow]);void 0===j||containsExtent(j,v)||(f=i.WGS84BoundingBox,M=getProjection("EPSG:4326").getExtent(),v=j,h=f?f[0]===M[0]&&f[2]===M[2]:(S=transformExtent(j,m.SupportedCRS,"EPSG:4326"))[0]-1e-10<=M[0]&&S[2]+1e-10>=M[2]);x=createFromCapabilitiesMatrixSet(m,v,a);const y=[];let C=n.requestEncoding;if(C=void 0!==C?C:"","OperationsMetadata"in e&&"GetTile"in e.OperationsMetadata){const _=e.OperationsMetadata.GetTile.DCP.HTTP.Get;for(let e=0,t=_.length;e<t;++e)if(_[e].Constraint){const F=_[e].Constraint.find(function(e){return"GetEncoding"==e.name}).AllowedValues.Value;if("KVP"!==(C=""===C?F[0]:C))break;F.includes("KVP")&&y.push(_[e].href)}else _[e].href&&(C="KVP",y.push(_[e].href))}return 0===y.length&&(C="REST",i.ResourceURL.forEach(function(e){"tile"===e.resourceType&&(l=e.format,y.push(e.template))})),{urls:y,layer:n.layer,matrixSet:s,format:l,projection:p,requestEncoding:C,tileGrid:x,style:c,dimensions:u,wrapX:h,crossOrigin:n.crossOrigin}}export{optionsFromCapabilities};