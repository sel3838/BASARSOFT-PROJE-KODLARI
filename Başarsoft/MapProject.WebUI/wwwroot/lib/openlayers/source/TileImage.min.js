import EventType from"../events/EventType.js";import ImageTile from"../ImageTile.js";import ReprojTile from"../reproj/Tile.js";import TileCache from"../TileCache.js";import TileState from"../TileState.js";import UrlTile from"./UrlTile.js";import{equivalent,get as getProjection}from"../proj.js";import{getKey,getKeyZXY}from"../tilecoord.js";import{getForProjection as getTileGridForProjection}from"../tilegrid.js";import{getUid}from"../util.js";class TileImage extends UrlTile{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,opaque:e.opaque,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction||defaultTileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX,transition:e.transition,interpolate:void 0===e.interpolate||e.interpolate,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.crossOrigin=void 0!==e.crossOrigin?e.crossOrigin:null,this.tileClass=void 0!==e.tileClass?e.tileClass:ImageTile,this.tileCacheForProjection={},this.tileGridForProjection={},this.reprojectionErrorThreshold_=e.reprojectionErrorThreshold,this.renderReprojectionEdges_=!1}canExpireCache(){if(this.tileCache.canExpireCache())return!0;for(const e in this.tileCacheForProjection)if(this.tileCacheForProjection[e].canExpireCache())return!0;return!1}expireCache(e,t){var i=this.getTileCacheForProjection(e);this.tileCache.expireCache(this.tileCache==i?t:{});for(const r in this.tileCacheForProjection){const o=this.tileCacheForProjection[r];o.expireCache(o==i?t:{})}}getGutterForProjection(e){return this.getProjection()&&e&&!equivalent(this.getProjection(),e)?0:this.getGutter()}getGutter(){return 0}getKey(){let e=super.getKey();return this.getInterpolate()||(e+=":disable-interpolation"),e}getOpaque(e){return!(this.getProjection()&&e&&!equivalent(this.getProjection(),e))&&super.getOpaque(e)}getTileGridForProjection(e){var t=this.getProjection();if(this.tileGrid&&(!t||equivalent(t,e)))return this.tileGrid;t=getUid(e);return t in this.tileGridForProjection||(this.tileGridForProjection[t]=getTileGridForProjection(e)),this.tileGridForProjection[t]}getTileCacheForProjection(e){var t=this.getProjection();if(!t||equivalent(t,e))return this.tileCache;t=getUid(e);return t in this.tileCacheForProjection||(this.tileCacheForProjection[t]=new TileCache(this.tileCache.highWaterMark)),this.tileCacheForProjection[t]}createTile_(e,t,i,r,o,n){e=[e,t,i],t=this.getTileCoordForTileUrlFunction(e,o),i=t?this.tileUrlFunction(t,r,o):void 0;const l=new this.tileClass(e,void 0!==i?TileState.IDLE:TileState.EMPTY,void 0!==i?i:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return l.key=n,l.addEventListener(EventType.CHANGE,this.handleTileChange.bind(this)),l}getTile(e,t,i,r,o){const n=this.getProjection();if(!n||!o||equivalent(n,o))return this.getTileInternal(e,t,i,r,n||o);const l=this.getTileCacheForProjection(o);e=[e,t,i];let s;t=getKey(e),l.containsKey(t)&&(s=l.get(t)),i=this.getKey();if(s&&s.key==i)return s;var c=this.getTileGridForProjection(n),a=this.getTileGridForProjection(o),h=this.getTileCoordForTileUrlFunction(e,o);const g=new ReprojTile(n,c,o,a,e,h,this.getTilePixelRatio(r),this.getGutter(),(e,t,i,r)=>this.getTileInternal(e,t,i,r,n),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_,this.tileOptions);return g.key=i,s?(g.interimTile=s,g.refreshInterimChain(),l.replace(t,g)):l.set(t,g),g}getTileInternal(e,t,i,r,o){let n=null;var l=getKeyZXY(e,t,i),s=this.getKey();if(this.tileCache.containsKey(l)){if((n=this.tileCache.get(l)).key!=s){const c=n;n=this.createTile_(e,t,i,r,o,s),c.getState()==TileState.IDLE?n.interimTile=c.interimTile:n.interimTile=c,n.refreshInterimChain(),this.tileCache.replace(l,n)}}else n=this.createTile_(e,t,i,r,o,s),this.tileCache.set(l,n);return n}setRenderReprojectionEdges(e){if(this.renderReprojectionEdges_!=e){this.renderReprojectionEdges_=e;for(const t in this.tileCacheForProjection)this.tileCacheForProjection[t].clear();this.changed()}}setTileGridForProjection(e,t){var e=getProjection(e);!e||(e=getUid(e))in this.tileGridForProjection||(this.tileGridForProjection[e]=t)}clear(){super.clear();for(const e in this.tileCacheForProjection)this.tileCacheForProjection[e].clear()}}function defaultTileLoadFunction(e,t){e.getImage().src=t}export default TileImage;