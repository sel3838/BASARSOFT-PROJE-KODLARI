import Projection from"./Projection.js";import{addCoordinateTransforms,addEquivalentProjections,addProjection,createSafeCoordinateTransform,get}from"../proj.js";import{get as getTransform}from"./transforms.js";let registered=null;function isRegistered(){return!!registered}function unregister(){registered=null}function register(r){registered=r;var e=Object.keys(r.defs),t=e.length;let o,s;for(o=0;o<t;++o){var n=e[o];if(!get(n)){var i=r.defs(n);let e=i.units;e||"longlat"!==i.projName||(e="degrees"),addProjection(new Projection({code:n,axisOrientation:i.axis,metersPerUnit:i.to_meter,units:e}))}}for(o=0;o<t;++o){var a=e[o],f=get(a);for(s=0;s<t;++s){var d=e[s],c=get(d);getTransform(a,d)||(r.defs[a]===r.defs[d]?addEquivalentProjections([f,c]):(d=r(a,d),addCoordinateTransforms(f,c,createSafeCoordinateTransform(f,c,d.forward),createSafeCoordinateTransform(c,f,d.inverse))))}}}let epsgLookup=async function(e){const r=await fetch(`https://epsg.io/${e}.proj4`);if(r.ok)return r.text();throw new Error("Unexpected response from epsg.io: "+r.status)};function setEPSGLookup(e){epsgLookup=e}function getEPSGLookup(){return epsgLookup}async function fromEPSGCode(e){"string"==typeof e&&(e=parseInt(e.split(":").pop(),10));const r=registered;if(!r)throw new Error("Proj4 must be registered first with register(proj4)");var t="EPSG:"+e;return r.defs(t)||(r.defs(t,await epsgLookup(e)),register(r)),get(t)}function epsgLookupMapTiler(r){return async function(n){const e=await fetch(`https://api.maptiler.com/coordinates/search/code:${n}.json?transformations=true&exports=true&key=`+r);if(e.ok)return e.json().then(e=>{const r=e.results;if(0<r?.length){e=r.filter(e=>"EPSG"===e.id?.authority&&e.id?.code===n)[0];if(e){const o=e.transformations;if(0<o?.length){const s=e.default_transformation;if(0<o.filter(e=>e.id?.authority===s?.authority&&e.id?.code===s?.code&&0===e.grids?.length).length)return e.exports?.proj4;var t=o.filter(e=>0===e.grids?.length&&"EPSG"===e.target_crs?.authority&&4326===e.target_crs?.code&&!1===e.deprecated&&!0===e.usable).sort((e,r)=>e.accuracy-r.accuracy)[0]?.exports?.proj4;if(t)return t}return e.exports?.proj4}}});throw new Error("Unexpected response from maptiler.com: "+e.status)}}export{isRegistered,unregister,register,setEPSGLookup,getEPSGLookup,fromEPSGCode,epsgLookupMapTiler};