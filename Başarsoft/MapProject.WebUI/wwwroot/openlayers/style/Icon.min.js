import EventType from"../events/EventType.js";import ImageState from"../ImageState.js";import ImageStyle from"./Image.js";import{asArray}from"../color.js";import{assert}from"../asserts.js";import{get as getIconImage}from"./IconImage.js";import{getUid}from"../util.js";function calculateScale(t,i,e,o){return void 0!==e&&void 0!==o?[e/t,o/i]:void 0!==e?e/t:void 0!==o?o/i:1}class Icon extends ImageStyle{constructor(e){var t=void 0!==(e=e||{}).opacity?e.opacity:1,i=void 0!==e.rotation?e.rotation:0,o=void 0!==e.scale?e.scale:1,s=void 0!==e.rotateWithView&&e.rotateWithView;super({opacity:t,rotation:i,scale:o,displacement:void 0!==e.displacement?e.displacement:[0,0],rotateWithView:s,declutterMode:e.declutterMode}),this.anchor_=void 0!==e.anchor?e.anchor:[.5,.5],this.normalizedAnchor_=null,this.anchorOrigin_=void 0!==e.anchorOrigin?e.anchorOrigin:"top-left",this.anchorXUnits_=void 0!==e.anchorXUnits?e.anchorXUnits:"fraction",this.anchorYUnits_=void 0!==e.anchorYUnits?e.anchorYUnits:"fraction",this.crossOrigin_=void 0!==e.crossOrigin?e.crossOrigin:null;const r=void 0!==e.img?e.img:null;let n=e.src;assert(!(void 0!==n&&r),"`image` and `src` cannot be provided at the same time"),void 0!==n&&0!==n.length||!r||(n=r.src||getUid(r)),assert(void 0!==n&&0<n.length,"A defined and non-empty `src` or `image` must be provided"),assert(!((void 0!==e.width||void 0!==e.height)&&void 0!==e.scale),"`width` or `height` cannot be provided together with `scale`");let a;if(void 0!==e.src?a=ImageState.IDLE:void 0!==r&&(a="complete"in r?r.complete?r.src?ImageState.LOADED:ImageState.IDLE:ImageState.LOADING:ImageState.LOADED),this.color_=void 0!==e.color?asArray(e.color):null,this.iconImage_=getIconImage(r,n,this.crossOrigin_,a,this.color_),this.offset_=void 0!==e.offset?e.offset:[0,0],this.offsetOrigin_=void 0!==e.offsetOrigin?e.offsetOrigin:"top-left",this.origin_=null,this.size_=void 0!==e.size?e.size:null,void 0!==e.width||void 0!==e.height){let t,i;if(e.size)[t,i]=e.size;else{const r=this.getImage(1);if(r.width&&r.height)t=r.width,i=r.height;else if(r instanceof HTMLImageElement){this.initialOptions_=e;const h=()=>{var t;this.unlistenImageChange(h),this.initialOptions_&&(t=this.iconImage_.getSize(),this.setScale(calculateScale(t[0],t[1],e.width,e.height)))};return void this.listenImageChange(h)}}void 0!==t&&this.setScale(calculateScale(t,i,e.width,e.height))}}clone(){let t,i,e;return this.initialOptions_?(i=this.initialOptions_.width,e=this.initialOptions_.height):(t=this.getScale(),t=Array.isArray(t)?t.slice():t),new Icon({anchor:this.anchor_.slice(),anchorOrigin:this.anchorOrigin_,anchorXUnits:this.anchorXUnits_,anchorYUnits:this.anchorYUnits_,color:this.color_&&this.color_.slice?this.color_.slice():this.color_||void 0,crossOrigin:this.crossOrigin_,offset:this.offset_.slice(),offsetOrigin:this.offsetOrigin_,opacity:this.getOpacity(),rotateWithView:this.getRotateWithView(),rotation:this.getRotation(),scale:t,width:i,height:e,size:null!==this.size_?this.size_.slice():void 0,src:this.getSrc(),displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()})}getAnchor(){let t=this.normalizedAnchor_;if(!t){t=this.anchor_;var i=this.getSize();if("fraction"==this.anchorXUnits_||"fraction"==this.anchorYUnits_){if(!i)return null;t=this.anchor_.slice(),"fraction"==this.anchorXUnits_&&(t[0]*=i[0]),"fraction"==this.anchorYUnits_&&(t[1]*=i[1])}if("top-left"!=this.anchorOrigin_){if(!i)return null;t===this.anchor_&&(t=this.anchor_.slice()),"top-right"!=this.anchorOrigin_&&"bottom-right"!=this.anchorOrigin_||(t[0]=-t[0]+i[0]),"bottom-left"!=this.anchorOrigin_&&"bottom-right"!=this.anchorOrigin_||(t[1]=-t[1]+i[1])}this.normalizedAnchor_=t}var i=this.getDisplacement(),e=this.getScaleArray();return[t[0]-i[0]/e[0],t[1]+i[1]/e[1]]}setAnchor(t){this.anchor_=t,this.normalizedAnchor_=null}getColor(){return this.color_}getImage(t){return this.iconImage_.getImage(t)}getPixelRatio(t){return this.iconImage_.getPixelRatio(t)}getImageSize(){return this.iconImage_.getSize()}getImageState(){return this.iconImage_.getImageState()}getHitDetectionImage(){return this.iconImage_.getHitDetectionImage()}getOrigin(){if(this.origin_)return this.origin_;let t=this.offset_;if("top-left"!=this.offsetOrigin_){var i=this.getSize(),e=this.iconImage_.getSize();if(!i||!e)return null;t=t.slice(),"top-right"!=this.offsetOrigin_&&"bottom-right"!=this.offsetOrigin_||(t[0]=e[0]-i[0]-t[0]),"bottom-left"!=this.offsetOrigin_&&"bottom-right"!=this.offsetOrigin_||(t[1]=e[1]-i[1]-t[1])}return this.origin_=t,this.origin_}getSrc(){return this.iconImage_.getSrc()}getSize(){return this.size_||this.iconImage_.getSize()}getWidth(){var t=this.getScaleArray();return this.size_?this.size_[0]*t[0]:this.iconImage_.getImageState()==ImageState.LOADED?this.iconImage_.getSize()[0]*t[0]:void 0}getHeight(){var t=this.getScaleArray();return this.size_?this.size_[1]*t[1]:this.iconImage_.getImageState()==ImageState.LOADED?this.iconImage_.getSize()[1]*t[1]:void 0}setScale(t){delete this.initialOptions_,super.setScale(t)}listenImageChange(t){this.iconImage_.addEventListener(EventType.CHANGE,t)}load(){this.iconImage_.load()}unlistenImageChange(t){this.iconImage_.removeEventListener(EventType.CHANGE,t)}ready(){return this.iconImage_.ready()}}export default Icon;