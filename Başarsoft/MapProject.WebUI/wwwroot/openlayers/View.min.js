import BaseObject from"./Object.js";import ViewHint from"./ViewHint.js";import ViewProperty from"./ViewProperty.js";import{DEFAULT_TILE_SIZE}from"./tilegrid/common.js";import{METERS_PER_UNIT,createProjection,disableCoordinateWarning,fromUserCoordinate,fromUserExtent,getUserProjection,toUserCoordinate,toUserExtent}from"./proj.js";import{VOID}from"./functions.js";import{add as addCoordinate,equals as coordinatesEqual,equals,rotate as rotateCoordinate}from"./coordinate.js";import{assert}from"./asserts.js";import{none as centerNone,createExtent}from"./centerconstraint.js";import{clamp,modulo}from"./math.js";import{createMinMaxResolution,createSnapToPower,createSnapToResolutions}from"./resolutionconstraint.js";import{createSnapToN,createSnapToZero,disable,none as rotationNone}from"./rotationconstraint.js";import{easeOut,inAndOut}from"./easing.js";import{getCenter,getForViewAndSize,getHeight,getWidth,isEmpty}from"./extent.js";import{linearFindNearest}from"./array.js";import{fromExtent as polygonFromExtent}from"./geom/Polygon.js";const DEFAULT_MIN_ZOOM=0;class View extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t=Object.assign({},t),this.hints_=[0,0],this.animations_=[],this.updateAnimationKey_,this.projection_=createProjection(t.projection,"EPSG:3857"),this.viewportSize_=[100,100],this.targetCenter_=null,this.targetResolution_,this.targetRotation_,this.nextCenter_=null,this.nextResolution_,this.nextRotation_,this.cancelAnchor_=void 0,t.projection&&disableCoordinateWarning(),t.center&&(t.center=fromUserCoordinate(t.center,this.projection_)),t.extent&&(t.extent=fromUserExtent(t.extent,this.projection_)),this.applyOptions_(t)}applyOptions_(t){const e=Object.assign({},t);for(const s in ViewProperty)delete e[s];this.setProperties(e,!0);var o=createResolutionConstraint(t),i=(this.maxResolution_=o.maxResolution,this.minResolution_=o.minResolution,this.zoomFactor_=o.zoomFactor,this.resolutions_=t.resolutions,this.padding_=t.padding,this.minZoom_=o.minZoom,createCenterConstraint(t)),o=o.constraint,n=createRotationConstraint(t);this.constraints_={center:i,resolution:o,rotation:n},this.setRotation(void 0!==t.rotation?t.rotation:0),this.setCenterInternal(void 0!==t.center?t.center:null),void 0!==t.resolution?this.setResolution(t.resolution):void 0!==t.zoom&&this.setZoom(t.zoom)}get padding(){return this.padding_}set padding(t){var e,o,i=this.padding_,n=(this.padding_=t,this.getCenterInternal());n&&(t=t||[0,0,0,0],i=i||[0,0,0,0],e=(o=this.getResolution())/2*(t[3]-i[3]+i[1]-t[1]),o=o/2*(t[0]-i[0]+i[2]-t[2]),this.setCenterInternal([n[0]+e,n[1]-o]))}getUpdatedOptions_(t){const e=this.getProperties();return void 0!==e.resolution?e.resolution=this.getResolution():e.zoom=this.getZoom(),e.center=this.getCenterInternal(),e.rotation=this.getRotation(),Object.assign({},e,t)}animate(t){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);const o=new Array(arguments.length);for(let e=0;e<o.length;++e){let t=arguments[e];t.center&&((t=Object.assign({},t)).center=fromUserCoordinate(t.center,this.getProjection())),t.anchor&&((t=Object.assign({},t)).anchor=fromUserCoordinate(t.anchor,this.getProjection())),o[e]=t}this.animateInternal.apply(this,o)}animateInternal(t){let n=arguments.length,s,r=(1<n&&"function"==typeof arguments[n-1]&&(s=arguments[n-1],--n),0);for(;r<n&&!this.isDef();++r){var e=arguments[r];e.center&&this.setCenterInternal(e.center),void 0!==e.zoom?this.setZoom(e.zoom):e.resolution&&this.setResolution(e.resolution),void 0!==e.rotation&&this.setRotation(e.rotation)}if(r===n)s&&animationCallback(s,!0);else{let t=Date.now(),e=this.targetCenter_.slice(),o=this.targetResolution_,i=this.targetRotation_;const h=[];for(;r<n;++r){const l=arguments[r],u={start:t,complete:!1,anchor:l.anchor,duration:void 0!==l.duration?l.duration:1e3,easing:l.easing||inAndOut,callback:s};var a;l.center&&(u.sourceCenter=e,u.targetCenter=l.center.slice(),e=u.targetCenter),void 0!==l.zoom?(u.sourceResolution=o,u.targetResolution=this.getResolutionForZoom(l.zoom),o=u.targetResolution):l.resolution&&(u.sourceResolution=o,u.targetResolution=l.resolution,o=u.targetResolution),void 0!==l.rotation&&(u.sourceRotation=i,a=modulo(l.rotation-i+Math.PI,2*Math.PI)-Math.PI,u.targetRotation=i+a,i=u.targetRotation),isNoopAnimation(u)?u.complete=!0:t+=u.duration,h.push(u)}this.animations_.push(h),this.setHint(ViewHint.ANIMATING,1),this.updateAnimations_()}}getAnimating(){return 0<this.hints_[ViewHint.ANIMATING]}getInteracting(){return 0<this.hints_[ViewHint.INTERACTING]}cancelAnimations(){this.setHint(ViewHint.ANIMATING,-this.hints_[ViewHint.ANIMATING]);let o;for(let t=0,e=this.animations_.length;t<e;++t){var i=this.animations_[t];if(i[0].callback&&animationCallback(i[0].callback,!1),!o)for(let t=0,e=i.length;t<e;++t){var n=i[t];if(!n.complete){o=n.anchor;break}}}this.animations_.length=0,this.cancelAnchor_=o,this.nextCenter_=null,this.nextResolution_=NaN,this.nextRotation_=NaN}updateAnimations_(){if(void 0!==this.updateAnimationKey_&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),this.getAnimating()){var n=Date.now();let i=!1;for(let t=this.animations_.length-1;0<=t;--t){var e,s=this.animations_[t];let o=!0;for(let t=0,e=s.length;t<e;++t){const g=s[t];if(!g.complete){var r=n-g.start;let t=0<g.duration?r/g.duration:1;1<=t?(g.complete=!0,t=1):o=!1;var a,h,l,u,r=g.easing(t);if(g.sourceCenter&&(h=g.sourceCenter[0],u=g.sourceCenter[1],a=g.targetCenter[0],l=g.targetCenter[1],this.nextCenter_=g.targetCenter,this.targetCenter_=[h+r*(a-h),u+r*(l-u)]),g.sourceResolution&&g.targetResolution&&(a=1===r?g.targetResolution:g.sourceResolution+r*(g.targetResolution-g.sourceResolution),g.anchor&&(h=this.getViewportSize_(this.getRotation()),l=this.constraints_.resolution(a,0,h,!0),this.targetCenter_=this.calculateCenterZoom(l,g.anchor)),this.nextResolution_=g.targetResolution,this.targetResolution_=a,this.applyTargetState_(!0)),void 0!==g.sourceRotation&&void 0!==g.targetRotation&&(u=1===r?modulo(g.targetRotation+Math.PI,2*Math.PI)-Math.PI:g.sourceRotation+r*(g.targetRotation-g.sourceRotation),g.anchor&&(r=this.constraints_.rotation(u,!0),this.targetCenter_=this.calculateCenterRotate(r,g.anchor)),this.nextRotation_=g.targetRotation,this.targetRotation_=u),this.applyTargetState_(!0),i=!0,!g.complete)break}}o&&(this.animations_[t]=null,this.setHint(ViewHint.ANIMATING,-1),this.nextCenter_=null,this.nextResolution_=NaN,this.nextRotation_=NaN,(e=s[0].callback)&&animationCallback(e,!0))}this.animations_=this.animations_.filter(Boolean),i&&void 0===this.updateAnimationKey_&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}}calculateCenterRotate(t,e){let o;var i=this.getCenterInternal();return void 0!==i&&(o=[i[0]-e[0],i[1]-e[1]],rotateCoordinate(o,t-this.getRotation()),addCoordinate(o,e)),o}calculateCenterZoom(t,e){let o;var i,n=this.getCenterInternal(),s=this.getResolution();return void 0!==n&&void 0!==s&&(i=e[0]-t*(e[0]-n[0])/s,t=e[1]-t*(e[1]-n[1])/s,o=[i,t]),o}getViewportSize_(t){var e,o,i=this.viewportSize_;return t?(e=i[0],o=i[1],[Math.abs(e*Math.cos(t))+Math.abs(o*Math.sin(t)),Math.abs(e*Math.sin(t))+Math.abs(o*Math.cos(t))]):i}setViewportSize(t){this.viewportSize_=Array.isArray(t)?t.slice():[100,100],this.getAnimating()||this.resolveConstraints(0)}getCenter(){var t=this.getCenterInternal();return t&&toUserCoordinate(t,this.getProjection())}getCenterInternal(){return this.get(ViewProperty.CENTER)}getConstraints(){return this.constraints_}getConstrainResolution(){return this.get("constrainResolution")}getHints(t){return void 0!==t?(t[0]=this.hints_[0],t[1]=this.hints_[1],t):this.hints_.slice()}calculateExtent(t){t=this.calculateExtentInternal(t);return toUserExtent(t,this.getProjection())}calculateExtentInternal(t){t=t||this.getViewportSizeMinusPadding_();var e=this.getCenterInternal(),o=(assert(e,"The view center is not defined"),this.getResolution()),i=(assert(void 0!==o,"The view resolution is not defined"),this.getRotation());return assert(void 0!==i,"The view rotation is not defined"),getForViewAndSize(e,o,i,t)}getMaxResolution(){return this.maxResolution_}getMinResolution(){return this.minResolution_}getMaxZoom(){return this.getZoomForResolution(this.minResolution_)}setMaxZoom(t){this.applyOptions_(this.getUpdatedOptions_({maxZoom:t}))}getMinZoom(){return this.getZoomForResolution(this.maxResolution_)}setMinZoom(t){this.applyOptions_(this.getUpdatedOptions_({minZoom:t}))}setConstrainResolution(t){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:t}))}getProjection(){return this.projection_}getResolution(){return this.get(ViewProperty.RESOLUTION)}getResolutions(){return this.resolutions_}getResolutionForExtent(t,e){return this.getResolutionForExtentInternal(fromUserExtent(t,this.getProjection()),e)}getResolutionForExtentInternal(t,e){e=e||this.getViewportSizeMinusPadding_();var o=getWidth(t)/e[0],t=getHeight(t)/e[1];return Math.max(o,t)}getResolutionForValueFunction(e){e=e||2;const o=this.getConstrainedResolution(this.maxResolution_);var t=this.minResolution_;const i=Math.log(o/t)/Math.log(e);return function(t){return o/Math.pow(e,t*i)}}getRotation(){return this.get(ViewProperty.ROTATION)}getValueForResolutionFunction(t){const e=Math.log(t||2),o=this.getConstrainedResolution(this.maxResolution_);t=this.minResolution_;const i=Math.log(o/t)/e;return function(t){return Math.log(o/t)/e/i}}getViewportSizeMinusPadding_(t){let e=this.getViewportSize_(t);t=this.padding_;return e=t?[e[0]-t[1]-t[3],e[1]-t[0]-t[2]]:e}getState(){var t=this.getProjection(),e=this.getResolution(),o=this.getRotation();let i=this.getCenterInternal();var n,s=this.padding_;return s&&(n=this.getViewportSizeMinusPadding_(),i=calculateCenterOn(i,this.getViewportSize_(),[n[0]/2+s[3],n[1]/2+s[0]],e,o)),{center:i.slice(0),projection:void 0!==t?t:null,resolution:e,nextCenter:this.nextCenter_,nextResolution:this.nextResolution_,nextRotation:this.nextRotation_,rotation:o,zoom:this.getZoom()}}getViewStateAndExtent(){return{viewState:this.getState(),extent:this.calculateExtent()}}getZoom(){let t;var e=this.getResolution();return t=void 0!==e?this.getZoomForResolution(e):t}getZoomForResolution(t){let e=this.minZoom_||0,o,i;var n;return i=this.resolutions_?(n=linearFindNearest(this.resolutions_,t,1),e=n,o=this.resolutions_[n],n==this.resolutions_.length-1?2:o/this.resolutions_[n+1]):(o=this.maxResolution_,this.zoomFactor_),e+Math.log(o/t)/Math.log(i)}getResolutionForZoom(t){if(this.resolutions_){if(this.resolutions_.length<=1)return 0;var e=clamp(Math.floor(t),0,this.resolutions_.length-2),o=this.resolutions_[e]/this.resolutions_[e+1];return this.resolutions_[e]/Math.pow(o,clamp(t-e,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,t-this.minZoom_)}fit(t,e){let o;var i;assert(Array.isArray(t)||"function"==typeof t.getSimplifiedGeometry,"Invalid extent or geometry provided as `geometry`"),Array.isArray(t)?(assert(!isEmpty(t),"Cannot fit empty extent provided as `geometry`"),i=fromUserExtent(t,this.getProjection()),o=polygonFromExtent(i)):"Circle"===t.getType()?(i=fromUserExtent(t.getExtent(),this.getProjection()),(o=polygonFromExtent(i)).rotate(this.getRotation(),getCenter(i))):(i=getUserProjection(),o=i?t.clone().transform(i,this.getProjection()):t),this.fitInternal(o,e)}rotatedExtentForGeometry(t){var e=this.getRotation(),o=Math.cos(e),i=Math.sin(-e),n=t.getFlatCoordinates(),s=t.getStride();let r=1/0,a=1/0,h=-1/0,l=-1/0;for(let t=0,e=n.length;t<e;t+=s){var u=n[t]*o-n[t+1]*i,g=n[t]*i+n[t+1]*o;r=Math.min(r,u),a=Math.min(a,g),h=Math.max(h,u),l=Math.max(l,g)}return[r,a,h,l]}fitInternal(t,e){let o=(e=e||{}).size;o=o||this.getViewportSizeMinusPadding_();var i=void 0!==e.padding?e.padding:[0,0,0,0],n=void 0!==e.nearest&&e.nearest;let s;s=void 0!==e.minResolution?e.minResolution:void 0!==e.maxZoom?this.getResolutionForZoom(e.maxZoom):0;t=this.rotatedExtentForGeometry(t);let r=this.getResolutionForExtentInternal(t,[o[0]-i[1]-i[3],o[1]-i[0]-i[2]]);r=isNaN(r)?s:Math.max(r,s),r=this.getConstrainedResolution(r,n?0:1);var n=this.getRotation(),a=Math.sin(n),n=Math.cos(n);const h=getCenter(t);h[0]+=(i[1]-i[3])/2*r,h[1]+=(i[0]-i[2])/2*r;t=h[0]*n-h[1]*a,i=h[1]*n+h[0]*a,n=this.getConstrainedCenter([t,i],r),a=e.callback||VOID;void 0!==e.duration?this.animateInternal({resolution:r,center:n,duration:e.duration,easing:e.easing},a):(this.targetResolution_=r,this.targetCenter_=n,this.applyTargetState_(!1,!0),animationCallback(a,!0))}centerOn(t,e,o){this.centerOnInternal(fromUserCoordinate(t,this.getProjection()),e,o)}centerOnInternal(t,e,o){this.setCenterInternal(calculateCenterOn(t,e,o,this.getResolution(),this.getRotation()))}calculateCenterShift(t,e,o,i){let n;var s=this.padding_;return s&&t&&(i=calculateCenterOn(t,i,[(i=this.getViewportSizeMinusPadding_(-o))[0]/2+s[3],i[1]/2+s[0]],e,o),n=[t[0]-i[0],t[1]-i[1]]),n}isDef(){return!!this.getCenterInternal()&&void 0!==this.getResolution()}adjustCenter(t){var e=toUserCoordinate(this.targetCenter_,this.getProjection());this.setCenter([e[0]+t[0],e[1]+t[1]])}adjustCenterInternal(t){var e=this.targetCenter_;this.setCenterInternal([e[0]+t[0],e[1]+t[1]])}adjustResolution(t,e){e=e&&fromUserCoordinate(e,this.getProjection()),this.adjustResolutionInternal(t,e)}adjustResolutionInternal(t,e){var o=this.getAnimating()||this.getInteracting(),i=this.getViewportSize_(this.getRotation()),i=this.constraints_.resolution(this.targetResolution_*t,0,i,o);e&&(this.targetCenter_=this.calculateCenterZoom(i,e)),this.targetResolution_*=t,this.applyTargetState_()}adjustZoom(t,e){this.adjustResolution(Math.pow(this.zoomFactor_,-t),e)}adjustRotation(t,e){e=e&&fromUserCoordinate(e,this.getProjection()),this.adjustRotationInternal(t,e)}adjustRotationInternal(t,e){var o=this.getAnimating()||this.getInteracting(),o=this.constraints_.rotation(this.targetRotation_+t,o);e&&(this.targetCenter_=this.calculateCenterRotate(o,e)),this.targetRotation_+=t,this.applyTargetState_()}setCenter(t){this.setCenterInternal(t&&fromUserCoordinate(t,this.getProjection()))}setCenterInternal(t){this.targetCenter_=t,this.applyTargetState_()}setHint(t,e){return this.hints_[t]+=e,this.changed(),this.hints_[t]}setResolution(t){this.targetResolution_=t,this.applyTargetState_()}setRotation(t){this.targetRotation_=t,this.applyTargetState_()}setZoom(t){this.setResolution(this.getResolutionForZoom(t))}applyTargetState_(t,e){var e=this.getAnimating()||this.getInteracting()||e,o=this.constraints_.rotation(this.targetRotation_,e),i=this.getViewportSize_(o),n=this.constraints_.resolution(this.targetResolution_,0,i,e),e=this.constraints_.center(this.targetCenter_,n,i,e,this.calculateCenterShift(this.targetCenter_,n,o,i));this.get(ViewProperty.ROTATION)!==o&&this.set(ViewProperty.ROTATION,o),this.get(ViewProperty.RESOLUTION)!==n&&(this.set(ViewProperty.RESOLUTION,n),this.set("zoom",this.getZoom(),!0)),e&&this.get(ViewProperty.CENTER)&&equals(this.get(ViewProperty.CENTER),e)||this.set(ViewProperty.CENTER,e),this.getAnimating()&&!t&&this.cancelAnimations(),this.cancelAnchor_=void 0}resolveConstraints(t,e,o){t=void 0!==t?t:200;var e=e||0,i=this.constraints_.rotation(this.targetRotation_),n=this.getViewportSize_(i),e=this.constraints_.resolution(this.targetResolution_,e,n),n=this.constraints_.center(this.targetCenter_,e,n,!1,this.calculateCenterShift(this.targetCenter_,e,i,n));if(0===t&&!this.cancelAnchor_)return this.targetResolution_=e,this.targetRotation_=i,this.targetCenter_=n,void this.applyTargetState_();o=o||(0===t?this.cancelAnchor_:void 0),this.cancelAnchor_=void 0,this.getResolution()===e&&this.getRotation()===i&&this.getCenterInternal()&&equals(this.getCenterInternal(),n)||(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:i,center:n,resolution:e,duration:t,easing:easeOut,anchor:o}))}beginInteraction(){this.resolveConstraints(0),this.setHint(ViewHint.INTERACTING,1)}endInteraction(t,e,o){o=o&&fromUserCoordinate(o,this.getProjection()),this.endInteractionInternal(t,e,o)}endInteractionInternal(t,e,o){this.getInteracting()&&(this.setHint(ViewHint.INTERACTING,-1),this.resolveConstraints(t,e,o))}getConstrainedCenter(t,e){var o=this.getViewportSize_(this.getRotation());return this.constraints_.center(t,e||this.getResolution(),o)}getConstrainedZoom(t,e){t=this.getResolutionForZoom(t);return this.getZoomForResolution(this.getConstrainedResolution(t,e))}getConstrainedResolution(t,e){e=e||0;var o=this.getViewportSize_(this.getRotation());return this.constraints_.resolution(t,e,o)}}function animationCallback(t,e){setTimeout(function(){t(e)},0)}function createCenterConstraint(t){var e;if(void 0!==t.extent)return e=void 0===t.smoothExtentConstraint||t.smoothExtentConstraint,createExtent(t.extent,t.constrainOnlyCenter,e);const o=createProjection(t.projection,"EPSG:3857");if(!0!==t.multiWorld&&o.isGlobal()){const i=o.getExtent().slice();return i[0]=-1/0,i[2]=1/0,createExtent(i,!1,!1)}return centerNone}function createResolutionConstraint(t){let e,o,i;let n=void 0!==t.minZoom?t.minZoom:DEFAULT_MIN_ZOOM,s=void 0!==t.maxZoom?t.maxZoom:28;var r=void 0!==t.zoomFactor?t.zoomFactor:2,a=void 0!==t.multiWorld&&t.multiWorld,h=void 0===t.smoothResolutionConstraint||t.smoothResolutionConstraint,l=void 0!==t.showFullExtent&&t.showFullExtent;const u=createProjection(t.projection,"EPSG:3857");var g=u.getExtent();let c=t.constrainOnlyCenter,m=t.extent;return a||m||!u.isGlobal()||(c=!1,m=g),{constraint:e=void 0!==t.resolutions?(a=t.resolutions,o=a[n],i=void 0!==a[s]?a[s]:a[a.length-1],t.constrainResolution?createSnapToResolutions(a,h,!c&&m,l):createMinMaxResolution(o,i,h,!c&&m,l)):(g=(a=(g?Math.max(getWidth(g),getHeight(g)):360*METERS_PER_UNIT.degrees/u.getMetersPerUnit())/DEFAULT_TILE_SIZE/Math.pow(2,DEFAULT_MIN_ZOOM))/Math.pow(2,28-DEFAULT_MIN_ZOOM),void 0!==(o=t.maxResolution)?n=0:o=a/Math.pow(r,n),void 0===(i=t.minResolution)&&(i=void 0!==t.maxZoom?void 0!==t.maxResolution?o/Math.pow(r,s):a/Math.pow(r,s):g),s=n+Math.floor(Math.log(o/i)/Math.log(r)),i=o/Math.pow(r,s-n),t.constrainResolution?createSnapToPower(r,o,i,h,!c&&m,l):createMinMaxResolution(o,i,h,!c&&m,l)),maxResolution:o,minResolution:i,minZoom:n,zoomFactor:r}}function createRotationConstraint(t){return void 0===t.enableRotation||t.enableRotation?void 0===(t=t.constrainRotation)||!0===t?createSnapToZero():!1!==t&&"number"==typeof t?createSnapToN(t):rotationNone:disable}function isNoopAnimation(t){return!(t.sourceCenter&&t.targetCenter&&!coordinatesEqual(t.sourceCenter,t.targetCenter))&&(t.sourceResolution===t.targetResolution&&t.sourceRotation===t.targetRotation)}function calculateCenterOn(t,e,o,i,n){var s=Math.cos(-n),n=Math.sin(-n),r=t[0]*s-t[1]*n,t=t[1]*s+t[0]*n;return[(r+=(e[0]/2-o[0])*i)*s-(t+=(o[1]-e[1]/2)*i)*(n=-n),t*s+r*n]}export default View;export{createCenterConstraint,createResolutionConstraint,createRotationConstraint,isNoopAnimation};