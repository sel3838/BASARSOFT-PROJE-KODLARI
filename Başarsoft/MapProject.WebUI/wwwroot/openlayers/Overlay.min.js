import BaseObject from"./Object.js";import MapEventType from"./MapEventType.js";import{CLASS_SELECTABLE}from"./css.js";import{containsExtent}from"./extent.js";import{listen,unlistenByKey}from"./events.js";import{outerHeight,outerWidth,removeChildren,removeNode}from"./dom.js";const Property={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Overlay extends BaseObject{constructor(e){super(),this.on,this.once,this.un,this.options=e,this.id=e.id,this.insertFirst=void 0===e.insertFirst||e.insertFirst,this.stopEvent=void 0===e.stopEvent||e.stopEvent,this.element=document.createElement("div"),this.element.className=void 0!==e.className?e.className:"ol-overlay-container "+CLASS_SELECTABLE,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=!0===e.autoPan?{}:e.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(Property.ELEMENT,this.handleElementChanged),this.addChangeListener(Property.MAP,this.handleMapChanged),this.addChangeListener(Property.OFFSET,this.handleOffsetChanged),this.addChangeListener(Property.POSITION,this.handlePositionChanged),this.addChangeListener(Property.POSITIONING,this.handlePositioningChanged),void 0!==e.element&&this.setElement(e.element),this.setOffset(void 0!==e.offset?e.offset:[0,0]),this.setPositioning(e.positioning||"top-left"),void 0!==e.position&&this.setPosition(e.position)}getElement(){return this.get(Property.ELEMENT)}getId(){return this.id}getMap(){return this.get(Property.MAP)||null}getOffset(){return this.get(Property.OFFSET)}getPosition(){return this.get(Property.POSITION)}getPositioning(){return this.get(Property.POSITIONING)}handleElementChanged(){removeChildren(this.element);var e=this.getElement();e&&this.element.appendChild(e)}handleMapChanged(){this.mapPostrenderListenerKey&&(removeNode(this.element),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const e=this.getMap();if(e){this.mapPostrenderListenerKey=listen(e,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition();const t=this.stopEvent?e.getOverlayContainerStopEvent():e.getOverlayContainer();this.insertFirst?t.insertBefore(this.element,t.childNodes[0]||null):t.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(e){this.set(Property.ELEMENT,e)}setMap(e){this.set(Property.MAP,e)}setOffset(e){this.set(Property.OFFSET,e)}setPosition(e){this.set(Property.POSITION,e)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(e){const t=this.getMap();if(t&&t.getTargetElement()&&this.get(Property.POSITION)){var i=this.getRect(t.getTargetElement(),t.getSize()),n=this.getElement(),n=this.getRect(n,[outerWidth(n),outerHeight(n)]),s=void 0===(e=e||{}).margin?20:e.margin;if(!containsExtent(i,n)){var o=n[0]-i[0],r=i[2]-n[2],a=n[1]-i[1],i=i[3]-n[3];const h=[0,0];o<0?h[0]=o-s:r<0&&(h[0]=Math.abs(r)+s),a<0?h[1]=a-s:i<0&&(h[1]=Math.abs(i)+s),0===h[0]&&0===h[1]||(n=t.getView().getCenterInternal(),(o=t.getPixelFromCoordinateInternal(n))&&(r=[o[0]+h[0],o[1]+h[1]],a=e.animation||{},t.getView().animateInternal({center:t.getCoordinateFromPixelInternal(r),duration:a.duration,easing:a.easing})))}}}getRect(e,t){var e=e.getBoundingClientRect(),i=e.left+window.pageXOffset,e=e.top+window.pageYOffset;return[i,e,i+t[0],e+t[1]]}setPositioning(e){this.set(Property.POSITIONING,e)}setVisible(e){this.rendered.visible!==e&&(this.element.style.display=e?"":"none",this.rendered.visible=e)}updatePixelPosition(){const e=this.getMap();var t,i=this.getPosition();e&&e.isRendered()&&i?(i=e.getPixelFromCoordinate(i),t=e.getSize(),this.updateRenderedPosition(i,t)):this.setVisible(!1)}updateRenderedPosition(e,t){const i=this.element.style;var n=this.getOffset(),s=this.getPositioning(),o=(this.setVisible(!0),Math.round(e[0]+n[0])+"px"),e=Math.round(e[1]+n[1])+"px";let r="0%",a="0%";"bottom-right"==s||"center-right"==s||"top-right"==s?r="-100%":"bottom-center"!=s&&"center-center"!=s&&"top-center"!=s||(r="-50%"),"bottom-left"==s||"bottom-center"==s||"bottom-right"==s?a="-100%":"center-left"!=s&&"center-center"!=s&&"center-right"!=s||(a="-50%");n=`translate(${r}, ${a}) translate(${o}, ${e})`;this.rendered.transform_!=n&&(this.rendered.transform_=n,i.transform=n)}getOptions(){return this.options}}export default Overlay;