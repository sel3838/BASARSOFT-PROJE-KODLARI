import{appendParams}from"../uri.js";import{decode}from"../Image.js";import{getCenter,getHeight,getWidth}from"../extent.js";import{getRequestExtent}from"./Image.js";function getScale(e,t,r,n){var a=getWidth(e),e=getHeight(e),i=t[0],t=t[1],n=.0254/n;return i*e<t*a?a*r/(i*n):e*r/(t*n)}function getUrl(e,t,r,n,a,i,o){i=getScale(r,n,i,o),r=getCenter(r),a={OPERATION:a?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(n[0]),SETDISPLAYHEIGHT:Math.round(n[1]),SETVIEWSCALE:i,SETVIEWCENTERX:r[0],SETVIEWCENTERY:r[1]};return Object.assign(a,t),appendParams(e,a)}function createLoader(i){const o=i.load||decode;return function(t,e,r){const n=new Image;null!==i.crossOrigin&&(n.crossOrigin=i.crossOrigin),t=getRequestExtent(t,e,r,i.ratio);var a=getWidth(t)/e,e=getHeight(t)/e,a=getUrl(i.url,i.params,t,[a*r,e*r],i.useOverlay,i.metersPerUnit||1,i.displayDpi||96);return o(n,a).then(e=>({image:e,extent:t,pixelRatio:r}))}}export{createLoader};