import{DECIMALS}from"./common.js";import{appendParams}from"../uri.js";import{decode}from"../Image.js";import{getHeight,getWidth}from"../extent.js";import{get as getProjection}from"../proj.js";import{getRequestExtent}from"./Image.js";import{round}from"../math.js";function getRequestUrl(e,r,t,o,i,n){i=i.getCode().split(/:(?=\d+$)/).pop(),t/=o,t=[round(getWidth(r)/t,DECIMALS),round(getHeight(r)/t,DECIMALS)],n.SIZE=t[0]+","+t[1],n.BBOX=r.join(","),n.BBOXSR=i,n.IMAGESR=i,n.DPI=Math.round(n.DPI?n.DPI*o:90*o),t=e.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return appendParams(t,n)}function createLoader(n){const a=n.load||decode,g=getProjection(n.projection||"EPSG:3857");return function(t,e,o){o=n.hidpi?o:1;var r={F:"image",FORMAT:"PNG32",TRANSPARENT:!0},e=(Object.assign(r,n.params),t=getRequestExtent(t,e,o,n.ratio),getRequestUrl(n.url,t,e,o,g,r));const i=new Image;return null!==n.crossOrigin&&(i.crossOrigin=n.crossOrigin),a(i,e).then(e=>{var r=getWidth(t)/e.width*o;return{image:e,extent:t,resolution:r,pixelRatio:o}})}}export{getRequestUrl,createLoader};