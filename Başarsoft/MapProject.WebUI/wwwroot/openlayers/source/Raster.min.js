import Disposable from"../Disposable.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import ImageCanvas from"../ImageCanvas.js";import ImageLayer from"../layer/Image.js";import ImageSource from"./Image.js";import Source from"./Source.js";import TileLayer from"../layer/Tile.js";import TileQueue from"../TileQueue.js";import TileSource from"./Tile.js";import{createCanvasContext2D}from"../dom.js";import{create as createTransform}from"../transform.js";import{equals,getCenter,getHeight,getWidth}from"../extent.js";import{getUid}from"../util.js";let hasImageData=!0;try{new ImageData(10,10)}catch(e){hasImageData=!1}let context;function newImageData(e,t,r){if(hasImageData)return new ImageData(e,t,r);const s=(context=context||document.createElement("canvas").getContext("2d")).createImageData(t,r);return s.data.set(e),s}function createMinion(_){let v=!0;try{new ImageData(10,10)}catch(e){v=!1}return function(e){var t,r,s,a=e.buffers,n=e.meta,i=e.imageOps,o=e.width,u=e.height,h=a.length,l=a[0].byteLength;if(i){const f=new Array(h);for(let e=0;e<h;++e)f[e]=(t=new Uint8ClampedArray(a[e]),r=o,s=u,v?new ImageData(t,r,s):{data:t,width:r,height:s});const c=_(f,n).data;return c.buffer}const c=new Uint8ClampedArray(l),d=new Array(h),m=new Array(h);for(let e=0;e<h;++e)d[e]=new Uint8ClampedArray(a[e]),m[e]=[0,0,0,0];for(let t=0;t<l;t+=4){for(let e=0;e<h;++e){var g=d[e];m[e][0]=g[t],m[e][1]=g[t+1],m[e][2]=g[t+2],m[e][3]=g[t+3]}var p=_(m,n);c[t]=p[0],c[t+1]=p[1],c[t+2]=p[2],c[t+3]=p[3]}return c.buffer}}function createWorker(t,e){const r=Object.keys(t.lib||{}).map(function(e){return"const "+e+" = "+t.lib[e].toString()+";"}),s=r.concat(["const __minion__ = ("+createMinion.toString()+")(",t.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),a=new Worker("undefined"==typeof Blob?"data:text/javascript;base64,"+Buffer.from(s.join("\n"),"binary").toString("base64"):URL.createObjectURL(new Blob(s,{type:"text/javascript"})));return a.addEventListener("message",e),a}function createFauxWorker(e,t){const r=createMinion(e.operation);let s=!1;return{postMessage:function(e){setTimeout(function(){s||t({data:{buffer:r(e),meta:e.meta}})},0)},terminate:function(){s=!0}}}class Processor extends Disposable{constructor(t){super(),this._imageOps=!!t.imageOps;let r;r=0===t.threads?0:!this._imageOps&&t.threads||1;const s=new Array(r);if(r)for(let e=0;e<r;++e)s[e]=createWorker(t,this._onWorkerMessage.bind(this,e));else s[0]=createFauxWorker(t,this._onWorkerMessage.bind(this,0));this._workers=s,this._queue=[],this._maxQueueLength=t.queue||1/0,this._running=0,this._dataLookup={},this._job=null}process(e,t,r){this._enqueue({inputs:e,meta:t,callback:r}),this._dispatch()}_enqueue(e){for(this._queue.push(e);this._queue.length>this._maxQueueLength;)this._queue.shift().callback(null,null)}_dispatch(){if(!this._running&&0!==this._queue.length){const i=this._queue.shift();var t=(this._job=i).inputs[0].width,r=i.inputs[0].height;const o=i.inputs.map(function(e){return e.data.buffer});var s=this._workers.length;if(1===(this._running=s))this._workers[0].postMessage({buffers:o,meta:i.meta,imageOps:this._imageOps,width:t,height:r},o);else{var e=i.inputs[0].data.length,a=4*Math.ceil(e/4/s);for(let e=0;e<s;++e){var n=e*a;const u=[];for(let e=0,t=o.length;e<t;++e)u.push(o[e].slice(n,n+a));this._workers[e].postMessage({buffers:u,meta:i.meta,imageOps:this._imageOps,width:t,height:r},u)}}}}_onWorkerMessage(e,t){this.disposed||(this._dataLookup[e]=t.data,--this._running,0===this._running&&this._resolveJob())}_resolveJob(){const e=this._job;var t=this._workers.length;let r,s;if(1===t)r=new Uint8ClampedArray(this._dataLookup[0].buffer),s=this._dataLookup[0].meta;else{var a=e.inputs[0].data.length,n=(r=new Uint8ClampedArray(a),s=new Array(t),4*Math.ceil(a/4/t));for(let e=0;e<t;++e){var i=this._dataLookup[e].buffer,o=e*n;r.set(new Uint8ClampedArray(i),o),s[e]=this._dataLookup[e].meta}}this._job=null,this._dataLookup={},e.callback(null,newImageData(r,e.inputs[0].width,e.inputs[0].height),s),this._dispatch()}disposeInternal(){for(let e=0;e<this._workers.length;++e)this._workers[e].terminate();this._workers.length=0}}const RasterEventType={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class RasterSourceEvent extends Event{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class RasterSource extends ImageSource{constructor(u){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=void 0!==u.operationType?u.operationType:"pixel",this.threads_=void 0!==u.threads?u.threads:1,this.layers_=createLayers(u.sources);var r=this.changed.bind(this);for(let e=0,t=this.layers_.length;e<t;++e)this.layers_[e].addEventListener(EventType.CHANGE,r);this.useResolutions_=null!==u.resolutions,this.tileQueue_=new TileQueue(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:createTransform(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:getLayerStatesArray(this.layers_),pixelRatio:1,pixelToCoordinateTransform:createTransform(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:getUid(this),renderTargets:{}},this.setAttributions(function(r){const s=[];for(let e=0,t=u.sources.length;e<t;++e){const n=u.sources[e],i=n instanceof Source?n:n.getSource();if(i){const o=i.getAttributions();var a;"function"==typeof o&&(a=o(r),s.push.apply(s,a))}}return 0!==s.length?s:null}),void 0!==u.operation&&this.setOperation(u.operation,u.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new Processor({operation:e,imageOps:"image"===this.operationType_,queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const s=Object.assign({},this.frameState_);s.viewState=Object.assign({},s.viewState);var a=getCenter(e);s.size[0]=Math.ceil(getWidth(e)/t),s.size[1]=Math.ceil(getHeight(e)/t),s.extent=[a[0]-s.size[0]*t/2,a[1]-s.size[1]*t/2,a[0]+s.size[0]*t/2,a[1]+s.size[1]*t/2],s.time=Date.now();const n=s.viewState;return n.center=a,n.projection=r,n.resolution=t,s}allSourcesReady_(){let r=!0,s;for(let e=0,t=this.layers_.length;e<t;++e)if(!(s=this.layers_[e].getSource())||"ready"!==s.getState()){r=!1;break}return r}getImage(e,t,r,s){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);var a,e=this.updateFrameState_(e,t,s);return this.requestedFrameState_=e,this.renderedImageCanvas_&&(s=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent(),t===s&&equals(e.extent,a)||(this.renderedImageCanvas_=null)),this.renderedImageCanvas_&&this.getRevision()===this.renderedRevision_||this.processSources_(),e.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const t=this.requestedFrameState_;var r=this.layers_.length;const s=new Array(r);for(let e=0;e<r;++e){t.layerIndex=e,t.renderTargets={};var a=getImageData(this.layers_[e],t);if(!a)return;s[e]=a}var e={};this.dispatchEvent(new RasterSourceEvent(RasterEventType.BEFOREOPERATIONS,t,e)),this.processor_.process(s,e,this.onWorkerComplete_.bind(this,t))}onWorkerComplete_(t,r,s,a){if(!r&&s){var n,i,r=t.extent,o=t.viewState.resolution;if(o===this.requestedFrameState_.viewState.resolution&&equals(r,this.requestedFrameState_.extent)){let e;this.renderedImageCanvas_?e=this.renderedImageCanvas_.getImage().getContext("2d"):(n=Math.round(getWidth(r)/o),i=Math.round(getHeight(r)/o),e=createCanvasContext2D(n,i),this.renderedImageCanvas_=new ImageCanvas(r,o,1,e.canvas)),e.putImageData(s,0,0),t.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new RasterSourceEvent(RasterEventType.AFTEROPERATIONS,t,a))}}}getResolutions(r){if(!this.useResolutions_)return null;let s=super.getResolutions();if(!s)for(let e=0,t=this.layers_.length;e<t;++e){const a=this.layers_[e].getSource();if(s=a.getResolutions(r))break}return s}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}RasterSource.prototype.dispose;let sharedContext=null;function getImageData(e,t){const r=e.getRenderer();if(!r)throw new Error("Unsupported layer type: "+e);if(!r.prepareFrame(t))return null;var e=t.size[0],s=t.size[1];if(0===e||0===s)return null;var t=r.renderFrame(t,null);let a;if(t instanceof HTMLCanvasElement)a=t;else{if(!((a=t?t.firstElementChild:a)instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+a);if(a.width===e&&a.height===s){const n=a.getContext("2d");return n.getImageData(0,0,e,s)}}return!sharedContext||(t=sharedContext.canvas).width!==e||t.height!==s?sharedContext=createCanvasContext2D(e,s,void 0,{willReadFrequently:!0}):sharedContext.clearRect(0,0,e,s),sharedContext.drawImage(a,0,0,e,s),sharedContext.getImageData(0,0,e,s)}function getLayerStatesArray(e){return e.map(function(e){return e.getLayerState()})}function createLayers(t){var r=t.length;const s=new Array(r);for(let e=0;e<r;++e)s[e]=createLayer(t[e]);return s}function createLayer(e){let t;return e instanceof Source?e instanceof TileSource?t=new TileLayer({source:e}):e instanceof ImageSource&&(t=new ImageLayer({source:e})):t=e,t}export default RasterSource;export{newImageData,Processor,RasterSourceEvent};