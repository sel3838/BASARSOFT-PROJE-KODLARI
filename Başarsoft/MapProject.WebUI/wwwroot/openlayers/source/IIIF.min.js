import TileGrid from"../tilegrid/TileGrid.js";import TileImage from"./TileImage.js";import{CustomTile}from"./Zoomify.js";import{DEFAULT_TILE_SIZE}from"../tilegrid/common.js";import{Versions}from"../format/IIIFInfo.js";import{assert}from"../asserts.js";import{getTopLeft}from"../extent.js";import{toSize}from"../size.js";function formatPercentage(e){return e.toLocaleString("en",{maximumFractionDigits:10})}class IIIF extends TileImage{constructor(e){e=e||{};let r=e.url||"";r+=r.lastIndexOf("/")===r.length-1||""===r?"":"/";const m=e.version||Versions.VERSION2,f=e.sizes||[];var t=e.size;assert(null!=t&&Array.isArray(t)&&2==t.length&&!isNaN(t[0])&&0<t[0]&&!isNaN(t[1])&&0<t[1],"Missing or invalid `size`");const g=t[0],h=t[1];t=e.tileSize;const i=e.tilePixelRatio||1,p=e.format||"jpg",d=e.quality||(e.version==Versions.VERSION1?"native":"default");let I=e.resolutions||[];const y=e.supports||[];var o=e.extent||[0,-h,g,0];const z=null!=f&&Array.isArray(f)&&0<f.length,N=void 0!==t&&("number"==typeof t&&Number.isInteger(t)&&0<t||Array.isArray(t)&&0<t.length),T=null!=y&&Array.isArray(y)&&(y.includes("regionByPx")||y.includes("regionByPct"))&&(y.includes("sizeByWh")||y.includes("sizeByH")||y.includes("sizeByW")||y.includes("sizeByPct"));let v,M,x;if(I.sort(function(e,t){return t-e}),N||T)if(null!=t&&("number"==typeof t&&Number.isInteger(t)&&0<t?(v=t,M=t):Array.isArray(t)&&0<t.length&&((1==t.length||null==t[1]&&Number.isInteger(t[0]))&&(v=t[0],M=t[0]),2==t.length&&(Number.isInteger(t[0])&&Number.isInteger(t[1])?(v=t[0],M=t[1]):null==t[0]&&Number.isInteger(t[1])&&(v=t[1],M=t[1])))),void 0!==v&&void 0!==M||(v=DEFAULT_TILE_SIZE,M=DEFAULT_TILE_SIZE),0==I.length)for(let e=x=Math.max(Math.ceil(Math.log(g/v)/Math.LN2),Math.ceil(Math.log(h/M)/Math.LN2));0<=e;e--)I.push(Math.pow(2,e));else{var s=Math.max(...I);x=Math.round(Math.log(s)/Math.LN2)}else if(v=g,M=h,I=[],z){f.sort(function(e,t){return e[0]-t[0]}),x=-1;const l=[];for(let e=0;e<f.length;e++){var n=g/f[e][0];0<I.length&&I[I.length-1]==n?l.push(e):(I.push(n),x++)}if(0<l.length)for(let e=0;e<l.length;e++)f.splice(l[e]-e,1)}else I.push(1),f.push([g,h]),x=0;s=new TileGrid({tileSize:[v,M],extent:o,origin:getTopLeft(o),resolutions:I}),o=CustomTile.bind(null,toSize(t||256).map(function(e){return e*i}));super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:e.state,tileClass:o,tileGrid:s,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:function(o,e,t){let s,n;var i=o[0];if(!(i>x)){var l=o[1],o=o[2],a=I[i];if(!(void 0===l||void 0===o||void 0===a||l<0||Math.ceil(g/a/v)<=l||o<0||Math.ceil(h/a/M)<=o)){if(T||N){var u,c,l=l*v*a,o=o*M*a;let e=v*a,t=M*a,i=v,r=M;l+e>g&&(e=g-l),o+t>h&&(t=h-o),l+v*a>g&&(i=Math.floor((g-l+a-1)/a)),o+M*a>h&&(r=Math.floor((h-o+a-1)/a)),0==l&&e==g&&0==o&&t==h?s="full":!T||y.includes("regionByPx")?s=l+","+o+","+e+","+t:y.includes("regionByPct")&&(l=formatPercentage(l/g*100),o=formatPercentage(o/h*100),u=formatPercentage(e/g*100),c=formatPercentage(t/h*100),s="pct:"+l+","+o+","+u+","+c),m!=Versions.VERSION3||T&&!y.includes("sizeByWh")?!T||y.includes("sizeByW")?n=i+",":y.includes("sizeByH")?n=","+r:y.includes("sizeByWh")?n=i+","+r:y.includes("sizeByPct")&&(n="pct:"+formatPercentage(100/a)):n=i+","+r}else s="full",n=z?(l=f[i][0],o=f[i][1],m==Versions.VERSION3?l==g&&o==h?"max":l+","+o:l==g?"full":l+","):m==Versions.VERSION3?"max":"full";return r+s+"/"+n+"/0/"+d+"."+p}}},transition:e.transition}),this.zDirection=e.zDirection}}export default IIIF;