import TileImage from"./TileImage.js";import{applyTransform,intersects}from"../extent.js";import{createFromTileUrlFunctions}from"../tileurlfunction.js";import{createOrUpdate}from"../tilecoord.js";import{createXYZ,extentFromProjection}from"../tilegrid.js";import{get as getProjection,getTransformFromProjections}from"../proj.js";function quadKey(e){var t=e[0];const r=new Array(t);let i=1<<t-1,o,s;for(o=0;o<t;++o)s=48,e[1]&i&&(s+=1),e[2]&i&&(s+=2),r[o]=String.fromCharCode(s),i>>=1;return r.join("")}const TOS_ATTRIBUTION='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class BingMaps extends TileImage{constructor(e){var t=void 0!==e.hidpi&&e.hidpi,t=(super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,opaque:!0,projection:getProjection("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:void 0===e.wrapX||e.wrapX,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=void 0!==e.culture?e.culture:"en-us",this.maxZoom_=void 0!==e.maxZoom?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles,"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_);fetch(t).then(e=>e.json()).then(e=>this.handleImageryMetadataResponse(e))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(200!=e.statusCode||"OK"!=e.statusDescription||"ValidCredentials"!=e.authenticationResultCode||1!=e.resourceSets.length||1!=e.resourceSets[0].resources.length)this.setState("error");else{const o=e.resourceSets[0].resources[0];var e=-1==this.maxZoom_?o.zoomMax:this.maxZoom_,t=this.getProjection(),t=extentFromProjection(t),r=this.hidpi_?2:1,r=o.imageWidth==o.imageHeight?o.imageWidth/r:[o.imageWidth/r,o.imageHeight/r],t=createXYZ({extent:t,minZoom:o.zoomMin,maxZoom:e,tileSize:r});this.tileGrid=t;const i=this.culture_,n=this.hidpi_,c=this.placeholderTiles_;if(this.tileUrlFunction=createFromTileUrlFunctions(o.imageUrlSubdomains.map(function(e){const s=[0,0,0],a=o.imageUrl.replace("{subdomain}",e).replace("{culture}",i);return function(e,t,r){if(e){createOrUpdate(e[0],e[1],e[2],s);const i=new URL(a.replace("{quadkey}",quadKey(s))),o=i.searchParams;return n&&(o.set("dpi","d1"),o.set("device","mobile")),!0===c?o.delete("n"):!1===c&&o.set("n","z"),i.toString()}}})),o.imageryProviders){const m=getTransformFromProjections(getProjection("EPSG:4326"),this.getProjection());this.setAttributions(s=>{const t=[];var e=s.viewState;const r=this.getTileGrid();var i=r.getZForResolution(e.resolution,this.zDirection);const a=r.getTileCoordForCoordAndZ(e.center,i)[0];return o.imageryProviders.map(function(e){let r=!1;var i=e.coverageAreas;for(let e=0,t=i.length;e<t;++e){var o=i[e];if(a>=o.zoomMin&&a<=o.zoomMax){o=o.bbox,o=[o[1],o[0],o[3],o[2]],o=applyTransform(o,m);if(intersects(o,s.extent)){r=!0;break}}}r&&t.push(e.attribution)}),t.push(TOS_ATTRIBUTION),t})}this.setState("ready")}}}export default BingMaps;export{quadKey};