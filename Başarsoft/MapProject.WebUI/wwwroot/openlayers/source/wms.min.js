import{DECIMALS}from"./common.js";import{appendParams}from"../uri.js";import{compareVersions}from"../string.js";import{decode}from"../Image.js";import{floor,round}from"../math.js";import{getForViewAndSize,getHeight,getWidth}from"../extent.js";import{get as getProjection}from"../proj.js";import{getRequestExtent}from"./Image.js";const DEFAULT_VERSION="1.3.0",GETFEATUREINFO_IMAGE_SIZE=[101,101];function getRequestUrl(e,r,t,o,a){a.WIDTH=t[0],a.HEIGHT=t[1];const n=o.getAxisOrientation();let i;t=0<=compareVersions(a.VERSION,"1.3");return a[t?"CRS":"SRS"]=o.getCode(),i=t&&"ne"==n.substr(0,2)?[r[1],r[0],r[3],r[2]]:r,a.BBOX=i.join(","),appendParams(e,a)}function getImageSrc(e,r,t,o,a,n,i){n=Object.assign({REQUEST:"GetMap"},n);r/=t,r=[round(getWidth(e)/r,DECIMALS),round(getHeight(e)/r,DECIMALS)];if(1!=t)switch(i){case"geoserver":var s=90*t+.5|0;"FORMAT_OPTIONS"in n?n.FORMAT_OPTIONS+=";dpi:"+s:n.FORMAT_OPTIONS="dpi:"+s;break;case"mapserver":n.MAP_RESOLUTION=90*t;break;case"carmentaserver":case"qgis":n.DPI=90*t;break;default:throw new Error("Unknown `serverType` configured")}return getRequestUrl(a,e,r,o,n)}function getRequestParams(e,r){return Object.assign({REQUEST:r,SERVICE:"WMS",VERSION:DEFAULT_VERSION,FORMAT:"image/png",STYLES:"",TRANSPARENT:!0},e)}function createLoader(a){const n=void 0===a.hidpi||a.hidpi,i=getProjection(a.projection||"EPSG:3857"),s=a.ratio||1.5,g=a.load||decode;return(r,e,t)=>{r=getRequestExtent(r,e,t,s),1==t||n&&void 0!==a.serverType||(t=1);e=getImageSrc(r,e,t,i,a.url,getRequestParams(a.params,"GetMap"),a.serverType);const o=new Image;return null!==a.crossOrigin&&(o.crossOrigin=a.crossOrigin),g(o,e).then(e=>({image:e,extent:r,pixelRatio:t}))}}function getFeatureInfoUrl(e,r,t){if(void 0!==e.url){var o=getProjection(e.projection||"EPSG:3857"),a=getForViewAndSize(r,t,0,GETFEATUREINFO_IMAGE_SIZE);const i={QUERY_LAYERS:e.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(i,getRequestParams(e.params,"GetFeatureInfo"),e.params);var n=floor((r[0]-a[0])/t,DECIMALS),r=floor((a[3]-r[1])/t,DECIMALS),t=0<=compareVersions(i.VERSION,"1.3");return i[t?"I":"X"]=n,i[t?"J":"Y"]=r,getRequestUrl(e.url,a,GETFEATUREINFO_IMAGE_SIZE,o,i)}}function getLegendUrl(e,r){if(void 0!==e.url){const o={SERVICE:"WMS",VERSION:DEFAULT_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===e.params||void 0===e.params.LAYER){var t=e.params.LAYERS;if(!(!Array.isArray(t)||1===t.length))return;o.LAYER=t}return void 0!==r&&(t=getProjection(e.projection||"EPSG:3857").getMetersPerUnit()||1,o.SCALE=r*t/28e-5),Object.assign(o,e.params),appendParams(e.url,o)}}export{DEFAULT_VERSION,getRequestUrl,getImageSrc,getRequestParams,createLoader,getFeatureInfoUrl,getLegendUrl};