import Collection from"../Collection.js";import CollectionEventType from"../CollectionEventType.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import ObjectEventType from"../ObjectEventType.js";import RBush from"../structs/RBush.js";import RenderFeature from"../render/Feature.js";import Source from"./Source.js";import VectorEventType from"./VectorEventType.js";import{TRUE,VOID}from"../functions.js";import{all as allStrategy}from"../loadingstrategy.js";import{assert}from"../asserts.js";import{containsExtent,equals,wrapAndSliceX}from"../extent.js";import{extend}from"../array.js";import{getUid}from"../util.js";import{isEmpty}from"../obj.js";import{listen,unlistenByKey}from"../events.js";import{xhr}from"../featureloader.js";class VectorSourceEvent extends Event{constructor(e,t,r){super(e),this.feature=t,this.features=r}}class VectorSource extends Source{constructor(e){super({attributions:(e=e||{}).attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:void 0===e.wrapX||e.wrapX}),this.on,this.once,this.un,this.loader_=VOID,this.format_=e.format,this.overlaps_=void 0===e.overlaps||e.overlaps,this.url_=e.url,void 0!==e.loader?this.loader_=e.loader:void 0!==this.url_&&(assert(this.format_,"`format` must be set when `url` is set"),this.loader_=xhr(this.url_,this.format_)),this.strategy_=void 0!==e.strategy?e.strategy:allStrategy;var t=void 0===e.useSpatialIndex||e.useSpatialIndex;this.featuresRtree_=t?new RBush:null,this.loadedExtentsRtree_=new RBush,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let r,s;Array.isArray(e.features)?s=e.features:e.features&&(r=e.features,s=r.getArray()),t||void 0!==r||(r=new Collection(s)),void 0!==s&&this.addFeaturesInternal(s),void 0!==r&&this.bindFeaturesCollection_(r)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){var t,r=getUid(e);if(this.addToIndex_(r,e)){this.setupChangeEvents_(r,e);const s=e.getGeometry();s?(t=s.getExtent(),this.featuresRtree_&&this.featuresRtree_.insert(t,e)):this.nullGeometryFeatures_[r]=e,this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,e))}else this.featuresCollection_&&this.featuresCollection_.remove(e)}setupChangeEvents_(e,t){t instanceof RenderFeature||(this.featureChangeKeys_[e]=[listen(t,EventType.CHANGE,this.handleFeatureChange_,this),listen(t,ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let r=!0;if(void 0!==t.getId()){var s=String(t.getId());if(s in this.idIndex_)if(t instanceof RenderFeature){const n=this.idIndex_[s];n instanceof RenderFeature?Array.isArray(n)?n.push(t):this.idIndex_[s]=[n,t]:r=!1}else r=!1;else this.idIndex_[s]=t}return r&&(assert(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),r}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(r){const s=[],n=[],i=[];for(let e=0,t=r.length;e<t;e++){var o=r[e],a=getUid(o);this.addToIndex_(a,o)&&n.push(o)}for(let e=0,t=n.length;e<t;e++){const l=n[e];var h,u=getUid(l);this.setupChangeEvents_(u,l);const d=l.getGeometry();d?(h=d.getExtent(),s.push(h),i.push(l)):this.nullGeometryFeatures_[u]=l}if(this.featuresRtree_&&this.featuresRtree_.load(s,i),this.hasListener(VectorEventType.ADDFEATURE))for(let e=0,t=n.length;e<t;e++)this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,n[e]))}bindFeaturesCollection_(t){let r=!1;this.addEventListener(VectorEventType.ADDFEATURE,function(e){r||(r=!0,t.push(e.feature),r=!1)}),this.addEventListener(VectorEventType.REMOVEFEATURE,function(e){r||(r=!0,t.remove(e.feature),r=!1)}),t.addEventListener(CollectionEventType.ADD,e=>{r||(r=!0,this.addFeature(e.element),r=!1)}),t.addEventListener(CollectionEventType.REMOVE,e=>{r||(r=!0,this.removeFeature(e.element),r=!1)}),this.featuresCollection_=t}clear(e){if(e){for(const t in this.featureChangeKeys_){const r=this.featureChangeKeys_[t];r.forEach(unlistenByKey)}this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(e=>{this.removeFeatureInternal(e)});for(const s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};e=new VectorSourceEvent(VectorEventType.CLEAR);this.dispatchEvent(e),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(r,s){var e=[r[0],r[1],r[0],r[1]];return this.forEachFeatureInExtent(e,function(e){const t=e.getGeometry();if(t instanceof RenderFeature||t.intersectsCoordinate(r))return s(e)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(r,s){return this.forEachFeatureInExtent(r,function(e){const t=e.getGeometry();if(t instanceof RenderFeature||t.intersectsExtent(r)){e=s(e);if(e)return e}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),isEmpty(this.nullGeometryFeatures_)||extend(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(e){t.push(e)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const r=wrapAndSliceX(e,t);return[].concat(...r.map(e=>this.featuresRtree_.getInExtent(e)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,s){const n=e[0],i=e[1];let o=null;const a=[NaN,NaN];let h=1/0;const u=[-1/0,-1/0,1/0,1/0];return s=s||TRUE,this.featuresRtree_.forEachInExtent(u,function(e){if(s(e)){const r=e.getGeometry();var t=h;(h=r instanceof RenderFeature?0:r.closestPointXY(n,i,a,h))<t&&(o=e,t=Math.sqrt(h),u[0]=n-t,u[1]=i-t,u[2]=n+t,u[3]=i+t)}}),o}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){e=this.idIndex_[e.toString()];return void 0!==e?e:null}getFeatureByUid(e){e=this.uidIndex_[e];return void 0!==e?e:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target;var r,e=getUid(t);const s=t.getGeometry(),n=(s?(r=s.getExtent(),e in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[e],this.featuresRtree_&&this.featuresRtree_.insert(r,t)):this.featuresRtree_&&this.featuresRtree_.update(r,t)):e in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[e]=t),t.getId());void 0!==n?(r=n.toString(),this.idIndex_[r]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[r]=t)):(this.removeFromIdIndex_(t),this.uidIndex_[e]=t),this.changed(),this.dispatchEvent(new VectorSourceEvent(VectorEventType.CHANGEFEATURE,t))}hasFeature(e){var t=e.getId();return void 0!==t?t in this.idIndex_:getUid(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&isEmpty(this.nullGeometryFeatures_):!this.featuresCollection_||0===this.featuresCollection_.getLength()}loadFeatures(e,r,s){const n=this.loadedExtentsRtree_;var i=this.strategy_(e,r,s);for(let e=0,t=i.length;e<t;++e){const o=i[e];n.forEachInExtent(o,function(e){return containsExtent(e.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADSTART)),this.loader_.call(this,o,r,s,e=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADEND,void 0,e))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADERROR))}),n.insert(o,{extent:o.slice()}))}this.loading=!(this.loader_.length<4)&&0<this.loadingExtentsCount_}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(t){const e=this.loadedExtentsRtree_;let r;e.forEachInExtent(t,function(e){if(equals(e.extent,t))return r=e,!0}),r&&e.remove(r)}removeFeatures(r){const s=[];for(let e=0,t=r.length;e<t;++e){var n=r[e],n=this.removeFeatureInternal(n);n&&s.push(n)}0<s.length&&this.changed()}removeFeature(e){e&&this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){var t=getUid(e);if(t in this.uidIndex_){t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e);const s=this.featureChangeKeys_[t],n=(s?.forEach(unlistenByKey),delete this.featureChangeKeys_[t],e.getId());if(void 0!==n){var r=n.toString();const i=this.idIndex_[r];i===e?delete this.idIndex_[r]:Array.isArray(i)&&(i.splice(i.indexOf(e),1),1===i.length&&(this.idIndex_[r]=i[0]))}return delete this.uidIndex_[t],this.hasListener(VectorEventType.REMOVEFEATURE)&&this.dispatchEvent(new VectorSourceEvent(VectorEventType.REMOVEFEATURE,e)),e}}removeFromIdIndex_(e){let t=!1;for(const r in this.idIndex_){const s=this.idIndex_[r];if(e instanceof RenderFeature&&Array.isArray(s)&&s.includes(e))s.splice(s.indexOf(e),1);else if(this.idIndex_[r]===e){delete this.idIndex_[r],t=!0;break}}return t}setLoader(e){this.loader_=e}setUrl(e){assert(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(xhr(e,this.format_))}}export default VectorSource;export{VectorSourceEvent};