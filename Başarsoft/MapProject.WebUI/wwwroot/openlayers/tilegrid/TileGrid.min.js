import TileRange,{createOrUpdate as createOrUpdateTileRange}from"../TileRange.js";import{DEFAULT_TILE_SIZE}from"./common.js";import{assert}from"../asserts.js";import{ceil,clamp,floor}from"../math.js";import{createOrUpdate,getTopLeft}from"../extent.js";import{createOrUpdate as createOrUpdateTileCoord}from"../tilecoord.js";import{intersectsLinearRing}from"../geom/flat/intersectsextent.js";import{isSorted,linearFindNearest}from"../array.js";import{toSize}from"../size.js";const tmpTileCoord=[0,0,0],DECIMALS=5;class TileGrid{constructor(t){this.minZoom=void 0!==t.minZoom?t.minZoom:0,this.resolutions_=t.resolutions,assert(isSorted(this.resolutions_,(t,e)=>e-t,!0),"`resolutions` must be sorted in descending order");let i;if(!t.origins)for(let t=0,e=this.resolutions_.length-1;t<e;++t)if(i){if(this.resolutions_[t]/this.resolutions_[t+1]!==i){i=void 0;break}}else i=this.resolutions_[t]/this.resolutions_[t+1];this.zoomFactor_=i,this.maxZoom=this.resolutions_.length-1,this.origin_=void 0!==t.origin?t.origin:null,this.origins_=null,void 0!==t.origins&&(this.origins_=t.origins,assert(this.origins_.length==this.resolutions_.length,"Number of `origins` and `resolutions` must be equal"));const o=t.extent;void 0===o||this.origin_||this.origins_||(this.origin_=getTopLeft(o)),assert(!this.origin_&&this.origins_||this.origin_&&!this.origins_,"Either `origin` or `origins` must be configured, never both"),this.tileSizes_=null,void 0!==t.tileSizes&&(this.tileSizes_=t.tileSizes,assert(this.tileSizes_.length==this.resolutions_.length,"Number of `tileSizes` and `resolutions` must be equal")),this.tileSize_=void 0!==t.tileSize?t.tileSize:this.tileSizes_?null:DEFAULT_TILE_SIZE,assert(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,"Either `tileSize` or `tileSizes` must be configured, never both"),this.extent_=void 0!==o?o:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],this.tmpExtent_=[0,0,0,0],void 0!==t.sizes?this.fullTileRanges_=t.sizes.map((t,e)=>{const i=new TileRange(Math.min(0,t[0]),Math.max(t[0]-1,-1),Math.min(0,t[1]),Math.max(t[1]-1,-1));return o&&(t=this.getTileRangeForExtentAndZ(o,e),i.minX=Math.max(t.minX,i.minX),i.maxX=Math.min(t.maxX,i.maxX),i.minY=Math.max(t.minY,i.minY),i.maxY=Math.min(t.maxY,i.maxY)),i}):o&&this.calculateTileRanges_(o)}forEachTileCoord(t,o,r){var s=this.getTileRangeForExtentAndZ(t,o);for(let i=s.minX,t=s.maxX;i<=t;++i)for(let t=s.minY,e=s.maxY;t<=e;++t)r([o,i,t])}forEachTileCoordParentTileRange(t,e,i,o){let r,s,n,l=null,a=t[0]-1;for(2===this.zoomFactor_?(s=t[1],n=t[2]):l=this.getTileCoordExtent(t,o);a>=this.minZoom;){if(r=void 0!==s&&void 0!==n?(s=Math.floor(s/2),n=Math.floor(n/2),createOrUpdateTileRange(s,s,n,n,i)):this.getTileRangeForExtentAndZ(l,a,i),e(a,r))return!0;--a}return!1}getExtent(){return this.extent_}getMaxZoom(){return this.maxZoom}getMinZoom(){return this.minZoom}getOrigin(t){return this.origin_||this.origins_[t]}getResolution(t){return this.resolutions_[t]}getResolutions(){return this.resolutions_}getTileCoordChildTileRange(t,e,i){if(t[0]<this.maxZoom){var o;if(2===this.zoomFactor_)return r=2*t[1],o=2*t[2],createOrUpdateTileRange(r,1+r,o,1+o,e);var r=this.getTileCoordExtent(t,i||this.tmpExtent_);return this.getTileRangeForExtentAndZ(r,t[0]+1,e)}return null}getTileRangeForTileCoordAndZ(t,e,i){if(e>this.maxZoom||e<this.minZoom)return null;var o=t[0],r=t[1],s=t[2];if(e===o)return createOrUpdateTileRange(r,s,r,s,i);if(this.zoomFactor_){var n=Math.pow(this.zoomFactor_,e-o),l=Math.floor(r*n),a=Math.floor(s*n);if(e<o)return createOrUpdateTileRange(l,l,a,a,i);o=Math.floor(n*(r+1))-1,r=Math.floor(n*(s+1))-1;return createOrUpdateTileRange(l,o,a,r,i)}n=this.getTileCoordExtent(t,this.tmpExtent_);return this.getTileRangeForExtentAndZ(n,e,i)}getTileRangeForExtentAndZ(t,e,i){this.getTileCoordForXYAndZ_(t[0],t[3],e,!1,tmpTileCoord);var o=tmpTileCoord[1],r=tmpTileCoord[2],t=(this.getTileCoordForXYAndZ_(t[2],t[1],e,!0,tmpTileCoord),tmpTileCoord[1]),e=tmpTileCoord[2];return createOrUpdateTileRange(o,t,r,e,i)}getTileCoordCenter(t){var e=this.getOrigin(t[0]),i=this.getResolution(t[0]),o=toSize(this.getTileSize(t[0]),this.tmpSize_);return[e[0]+(t[1]+.5)*o[0]*i,e[1]-(t[2]+.5)*o[1]*i]}getTileCoordExtent(t,e){var i=this.getOrigin(t[0]),o=this.getResolution(t[0]),r=toSize(this.getTileSize(t[0]),this.tmpSize_),s=i[0]+t[1]*r[0]*o,i=i[1]-(t[2]+1)*r[1]*o,t=s+r[0]*o,r=i+r[1]*o;return createOrUpdate(s,i,t,r,e)}getTileCoordForCoordAndResolution(t,e,i){return this.getTileCoordForXYAndResolution_(t[0],t[1],e,!1,i)}getTileCoordForXYAndResolution_(t,e,i,o,r){var s=this.getZForResolution(i),n=i/this.getResolution(s),l=this.getOrigin(s),a=toSize(this.getTileSize(s),this.tmpSize_);let h=n*(t-l[0])/i/a[0],g=n*(l[1]-e)/i/a[1];return g=o?(h=ceil(h,DECIMALS)-1,ceil(g,DECIMALS)-1):(h=floor(h,DECIMALS),floor(g,DECIMALS)),createOrUpdateTileCoord(s,h,g,r)}getTileCoordForXYAndZ_(t,e,i,o,r){var s=this.getOrigin(i),n=this.getResolution(i),l=toSize(this.getTileSize(i),this.tmpSize_);let a=(t-s[0])/n/l[0],h=(s[1]-e)/n/l[1];return h=o?(a=ceil(a,DECIMALS)-1,ceil(h,DECIMALS)-1):(a=floor(a,DECIMALS),floor(h,DECIMALS)),createOrUpdateTileCoord(i,a,h,r)}getTileCoordForCoordAndZ(t,e,i){return this.getTileCoordForXYAndZ_(t[0],t[1],e,!1,i)}getTileCoordResolution(t){return this.resolutions_[t[0]]}getTileSize(t){return this.tileSize_||this.tileSizes_[t]}getFullTileRange(t){return this.fullTileRanges_?this.fullTileRanges_[t]:this.extent_?this.getTileRangeForExtentAndZ(this.extent_,t):null}getZForResolution(t,e){t=linearFindNearest(this.resolutions_,t,e||0);return clamp(t,this.minZoom,this.maxZoom)}tileCoordIntersectsViewport(t,e){return intersectsLinearRing(e,0,e.length,2,this.getTileCoordExtent(t))}calculateTileRanges_(e){var i=this.resolutions_.length;const o=new Array(i);for(let t=this.minZoom;t<i;++t)o[t]=this.getTileRangeForExtentAndZ(e,t);this.fullTileRanges_=o}}export default TileGrid;