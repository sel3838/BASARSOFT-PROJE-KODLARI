import BaseObject from"./Object.js";import Collection from"./Collection.js";import CollectionEventType from"./CollectionEventType.js";import CompositeMapRenderer from"./renderer/Composite.js";import EventType from"./events/EventType.js";import Layer from"./layer/Layer.js";import LayerGroup,{GroupEvent}from"./layer/Group.js";import MapBrowserEvent from"./MapBrowserEvent.js";import MapBrowserEventHandler from"./MapBrowserEventHandler.js";import MapBrowserEventType from"./MapBrowserEventType.js";import MapEvent from"./MapEvent.js";import MapEventType from"./MapEventType.js";import MapProperty from"./MapProperty.js";import ObjectEventType from"./ObjectEventType.js";import PointerEventType from"./pointer/EventType.js";import RenderEventType from"./render/EventType.js";import TileQueue,{getTilePriority}from"./TileQueue.js";import View from"./View.js";import ViewHint from"./ViewHint.js";import{DEVICE_PIXEL_RATIO,PASSIVE_EVENT_LISTENERS}from"./has.js";import{TRUE}from"./functions.js";import{apply as applyTransform,create as createTransform}from"./transform.js";import{assert}from"./asserts.js";import{clone,createOrUpdateEmpty,equals as equalsExtent,getForViewAndSize,isEmpty}from"./extent.js";import{defaults as defaultControls}from"./control/defaults.js";import{defaults as defaultInteractions}from"./interaction/defaults.js";import{equals}from"./array.js";import{fromUserCoordinate,toUserCoordinate}from"./proj.js";import{getUid}from"./util.js";import{hasArea}from"./size.js";import{listen,unlistenByKey}from"./events.js";import{removeNode}from"./dom.js";import{warn}from"./console.js";function removeLayerMapProperty(e){e instanceof Layer?e.setMapInternal(null):e instanceof LayerGroup&&e.getLayers().forEach(removeLayerMapProperty)}function setLayerMapProperty(e,r){if(e instanceof Layer)e.setMapInternal(r);else if(e instanceof LayerGroup){var i=e.getLayers().getArray();for(let e=0,t=i.length;e<t;++e)setLayerMapProperty(i[e],r)}}class Map extends BaseObject{constructor(e){super(),this.on,this.once,this.un;var t=createOptionsInternal(e=e||{});this.renderComplete_,this.loaded_=!0,this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=void 0!==e.maxTilesLoading?e.maxTilesLoading:16,this.pixelRatio_=void 0!==e.pixelRatio?e.pixelRatio:DEVICE_PIXEL_RATIO,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=this.animationDelay_.bind(this),this.coordinateToPixelTransform_=createTransform(),this.pixelToCoordinateTransform_=createTransform(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.style.pointerEvents="none",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.style.pointerEvents="none",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_),this.mapBrowserEventHandler_=null,this.moveTolerance_=e.moveTolerance,this.keyboardEventTarget_=t.keyboardEventTarget,this.targetChangeHandlerKeys_=null,this.targetElement_=null,this.resizeObserver_=new ResizeObserver(()=>this.updateSize()),this.controls=t.controls||defaultControls(),this.interactions=t.interactions||defaultInteractions({onFocusOnly:!0}),this.overlays_=t.overlays,this.overlayIdIndex_={},this.renderer_=null,this.postRenderFunctions_=[],this.tileQueue_=new TileQueue(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addChangeListener(MapProperty.LAYERGROUP,this.handleLayerGroupChanged_),this.addChangeListener(MapProperty.VIEW,this.handleViewChanged_),this.addChangeListener(MapProperty.SIZE,this.handleSizeChanged_),this.addChangeListener(MapProperty.TARGET,this.handleTargetChanged_),this.setProperties(t.values);const r=this;!e.view||e.view instanceof View||e.view.then(function(e){r.setView(new View(e))}),this.controls.addEventListener(CollectionEventType.ADD,e=>{e.element.setMap(this)}),this.controls.addEventListener(CollectionEventType.REMOVE,e=>{e.element.setMap(null)}),this.interactions.addEventListener(CollectionEventType.ADD,e=>{e.element.setMap(this)}),this.interactions.addEventListener(CollectionEventType.REMOVE,e=>{e.element.setMap(null)}),this.overlays_.addEventListener(CollectionEventType.ADD,e=>{this.addOverlayInternal_(e.element)}),this.overlays_.addEventListener(CollectionEventType.REMOVE,e=>{const t=e.element.getId();void 0!==t&&delete this.overlayIdIndex_[t.toString()],e.element.setMap(null)}),this.controls.forEach(e=>{e.setMap(this)}),this.interactions.forEach(e=>{e.setMap(this)}),this.overlays_.forEach(this.addOverlayInternal_.bind(this))}addControl(e){this.getControls().push(e)}addInteraction(e){this.getInteractions().push(e)}addLayer(e){const t=this.getLayerGroup().getLayers();t.push(e)}handleLayerAdd_(e){setLayerMapProperty(e.layer,this)}addOverlay(e){this.getOverlays().push(e)}addOverlayInternal_(e){const t=e.getId();void 0!==t&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)}disposeInternal(){this.controls.clear(),this.interactions.clear(),this.overlays_.clear(),this.resizeObserver_.disconnect(),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(e,t,r){var i,n;if(this.frameState_&&this.renderer_)return e=this.getCoordinateFromPixelInternal(e),i=void 0!==(r=void 0!==r?r:{}).hitTolerance?r.hitTolerance:0,n=void 0!==r.layerFilter?r.layerFilter:TRUE,r=!1!==r.checkWrapped,this.renderer_.forEachFeatureAtCoordinate(e,this.frameState_,i,r,t,null,n,null)}getFeaturesAtPixel(e,t){const r=[];return this.forEachFeatureAtPixel(e,function(e){r.push(e)},t),r}getAllLayers(){const r=[];return function t(e){e.forEach(function(e){e instanceof LayerGroup?t(e.getLayers()):r.push(e)})}(this.getLayers()),r}hasFeatureAtPixel(e,t){if(!this.frameState_||!this.renderer_)return!1;var e=this.getCoordinateFromPixelInternal(e),r=void 0!==(t=void 0!==t?t:{}).layerFilter?t.layerFilter:TRUE,i=void 0!==t.hitTolerance?t.hitTolerance:0,t=!1!==t.checkWrapped;return this.renderer_.hasFeatureAtCoordinate(e,this.frameState_,i,t,r,null)}getEventCoordinate(e){return this.getCoordinateFromPixel(this.getEventPixel(e))}getEventCoordinateInternal(e){return this.getCoordinateFromPixelInternal(this.getEventPixel(e))}getEventPixel(e){const t=this.viewport_;var r=t.getBoundingClientRect(),i=this.getSize(),n=r.width/i[0],i=r.height/i[1],e="changedTouches"in e?e.changedTouches[0]:e;return[(e.clientX-r.left)/n,(e.clientY-r.top)/i]}getTarget(){return this.get(MapProperty.TARGET)}getTargetElement(){return this.targetElement_}getCoordinateFromPixel(e){return toUserCoordinate(this.getCoordinateFromPixelInternal(e),this.getView().getProjection())}getCoordinateFromPixelInternal(e){var t=this.frameState_;return t?applyTransform(t.pixelToCoordinateTransform,e.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(e){e=this.overlayIdIndex_[e.toString()];return void 0!==e?e:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(MapProperty.LAYERGROUP)}setLayers(e){const t=this.getLayerGroup();if(e instanceof Collection)t.setLayers(e);else{const r=t.getLayers();r.clear(),r.extend(e)}}getLayers(){return this.getLayerGroup().getLayers()}getLoadingOrNotReady(){var r=this.getLayerGroup().getLayerStatesArray();for(let e=0,t=r.length;e<t;++e){const n=r[e];if(n.visible){var i=n.layer.getRenderer();if(i&&!i.ready)return!0;i=n.layer.getSource();if(i&&i.loading)return!0}}return!1}getPixelFromCoordinate(e){e=fromUserCoordinate(e,this.getView().getProjection());return this.getPixelFromCoordinateInternal(e)}getPixelFromCoordinateInternal(e){var t=this.frameState_;return t?applyTransform(t.coordinateToPixelTransform,e.slice(0,2)):null}getRenderer(){return this.renderer_}getSize(){return this.get(MapProperty.SIZE)}getView(){return this.get(MapProperty.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOwnerDocument(){var e=this.getTargetElement();return e?e.ownerDocument:document}getTilePriority(e,t,r,i){return getTilePriority(this.frameState_,e,t,r,i)}handleBrowserEvent(e,t){t=t||e.type;t=new MapBrowserEvent(t,this,e);this.handleMapBrowserEvent(t)}handleMapBrowserEvent(t){if(this.frameState_){var e=t.originalEvent,r=e.type;if(r===PointerEventType.POINTERDOWN||r===EventType.WHEEL||r===EventType.KEYDOWN){const n=this.getOwnerDocument(),s=this.viewport_.getRootNode?this.viewport_.getRootNode():n;r=e.target;if(this.overlayContainerStopEvent_.contains(r)||!(s===n?n.documentElement:s).contains(r))return}if(t.frameState=this.frameState_,!1!==this.dispatchEvent(t)){var i=this.getInteractions().getArray().slice();for(let e=i.length-1;0<=e;e--){const o=i[e];if(o.getMap()===this&&o.getActive()&&this.getTargetElement())if(!o.handleEvent(t)||t.propagationStopped)break}}}}handlePostRender(){var r,i=this.frameState_;const n=this.tileQueue_;if(!n.isEmpty()){let e=this.maxTilesLoading_,t=e;!i||((r=i.viewHints)[ViewHint.ANIMATING]||r[ViewHint.INTERACTING])&&(r=8<Date.now()-i.time,e=r?0:8,t=r?0:2),n.getTilesLoading()<e&&(n.reprioritize(),n.loadMoreTiles(e,t))}i&&this.renderer_&&!i.animate&&(!0===this.renderComplete_?(this.hasListener(RenderEventType.RENDERCOMPLETE)&&this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,i),!1===this.loaded_&&(this.loaded_=!0,this.dispatchEvent(new MapEvent(MapEventType.LOADEND,this,i)))):!0===this.loaded_&&(this.loaded_=!1,this.dispatchEvent(new MapEvent(MapEventType.LOADSTART,this,i))));const s=this.postRenderFunctions_;for(let e=0,t=s.length;e<t;++e)s[e](this,i);s.length=0}handleSizeChanged_(){this.getView()&&!this.getView().getAnimating()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){if(this.mapBrowserEventHandler_){for(let e=0,t=this.targetChangeHandlerKeys_.length;e<t;++e)unlistenByKey(this.targetChangeHandlerKeys_[e]);this.targetChangeHandlerKeys_=null,this.viewport_.removeEventListener(EventType.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType.WHEEL,this.boundHandleBrowserEvent_),this.mapBrowserEventHandler_.dispose(),this.mapBrowserEventHandler_=null,removeNode(this.viewport_)}this.targetElement_&&(this.resizeObserver_.unobserve(this.targetElement_),(e=this.targetElement_.getRootNode())instanceof ShadowRoot&&this.resizeObserver_.unobserve(e.host),this.setSize(void 0));var e=this.getTarget();const t="string"==typeof e?document.getElementById(e):e;if(this.targetElement_=t){t.appendChild(this.viewport_),this.renderer_||(this.renderer_=new CompositeMapRenderer(this)),this.mapBrowserEventHandler_=new MapBrowserEventHandler(this,this.moveTolerance_);for(const r in MapBrowserEventType)this.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[r],this.handleMapBrowserEvent.bind(this));this.viewport_.addEventListener(EventType.CONTEXTMENU,this.boundHandleBrowserEvent_,!1),this.viewport_.addEventListener(EventType.WHEEL,this.boundHandleBrowserEvent_,!!PASSIVE_EVENT_LISTENERS&&{passive:!1});e=this.keyboardEventTarget_||t,e=(this.targetChangeHandlerKeys_=[listen(e,EventType.KEYDOWN,this.handleBrowserEvent,this),listen(e,EventType.KEYPRESS,this.handleBrowserEvent,this)],t.getRootNode());e instanceof ShadowRoot&&this.resizeObserver_.observe(e.host),this.resizeObserver_.observe(t)}else this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderTimeoutHandle_=void 0,this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0);this.updateSize()}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const e=this.getView();e&&(this.updateViewportSize_(this.getSize()),this.viewPropertyListenerKey_=listen(e,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(e,EventType.CHANGE,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);var e=this.getLayerGroup();e&&(this.handleLayerAdd_(new GroupEvent("addlayer",e)),this.layerGroupPropertyListenerKeys_=[listen(e,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(e,EventType.CHANGE,this.render,this),listen(e,"addlayer",this.handleLayerAdd_,this),listen(e,"removelayer",this.handleLayerRemove_,this)]),this.render()}isRendered(){return!!this.frameState_}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){var r=this.getLayerGroup().getLayerStatesArray();for(let e=0,t=r.length;e<t;++e){const i=r[e].layer;i.hasRenderer()&&i.getRenderer().handleFontsChanged()}}render(){this.renderer_&&void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(e){return this.getControls().remove(e)}removeInteraction(e){return this.getInteractions().remove(e)}removeLayer(e){const t=this.getLayerGroup().getLayers();return t.remove(e)}handleLayerRemove_(e){removeLayerMapProperty(e.layer)}removeOverlay(e){return this.getOverlays().remove(e)}renderFrame_(e){var t=this.getSize();const r=this.getView();var i,n,s=this.frameState_;let o=null;void 0!==t&&hasArea(t)&&r&&r.isDef()&&(i=r.getHints(this.frameState_?this.frameState_.viewHints:void 0),n=r.getState(),o={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutter:null,extent:getForViewAndSize(n.center,n.resolution,n.rotation,t),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:t,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:n,viewHints:i,wantedTiles:{},mapId:getUid(this),renderTargets:{}},n.nextCenter&&n.nextResolution&&(e=isNaN(n.nextRotation)?n.rotation:n.nextRotation,o.nextExtent=getForViewAndSize(n.nextCenter,n.nextResolution,e,t))),this.frameState_=o,this.renderer_.renderFrame(o),o&&(o.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,o.postRenderFunctions),!s||this.previousExtent_&&(isEmpty(this.previousExtent_)||equalsExtent(o.extent,this.previousExtent_))||(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,s)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),!this.previousExtent_||o.viewHints[ViewHint.ANIMATING]||o.viewHints[ViewHint.INTERACTING]||equalsExtent(o.extent,this.previousExtent_)||(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,o)),clone(o.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,o)),this.renderComplete_=this.hasListener(MapEventType.LOADSTART)||this.hasListener(MapEventType.LOADEND)||this.hasListener(RenderEventType.RENDERCOMPLETE)?!this.tileQueue_.getTilesLoading()&&!this.tileQueue_.getCount()&&!this.getLoadingOrNotReady():void 0,this.postRenderTimeoutHandle_||(this.postRenderTimeoutHandle_=setTimeout(()=>{this.postRenderTimeoutHandle_=void 0,this.handlePostRender()},0))}setLayerGroup(e){var t=this.getLayerGroup();t&&this.handleLayerRemove_(new GroupEvent("removelayer",t)),this.set(MapProperty.LAYERGROUP,e)}setSize(e){this.set(MapProperty.SIZE,e)}setTarget(e){this.set(MapProperty.TARGET,e)}setView(e){if(!e||e instanceof View)this.set(MapProperty.VIEW,e);else{this.set(MapProperty.VIEW,new View);const t=this;e.then(function(e){t.setView(new View(e))})}}updateSize(){const e=this.getTargetElement();let t=void 0;e&&(r=getComputedStyle(e),i=e.offsetWidth-parseFloat(r.borderLeftWidth)-parseFloat(r.paddingLeft)-parseFloat(r.paddingRight)-parseFloat(r.borderRightWidth),r=e.offsetHeight-parseFloat(r.borderTopWidth)-parseFloat(r.paddingTop)-parseFloat(r.paddingBottom)-parseFloat(r.borderBottomWidth),isNaN(i)||isNaN(r)||(t=[i,r],!hasArea(t)&&(e.offsetWidth||e.offsetHeight||e.getClientRects().length)&&warn("No map visible because the map container's width or height are 0.")));var r,i=this.getSize();!t||i&&equals(t,i)||(this.setSize(t),this.updateViewportSize_(t))}updateViewportSize_(e){const t=this.getView();t&&t.setViewportSize(e)}}function createOptionsInternal(e){let t=null;void 0!==e.keyboardEventTarget&&(t="string"==typeof e.keyboardEventTarget?document.getElementById(e.keyboardEventTarget):e.keyboardEventTarget);const r={};var i=e.layers&&"function"==typeof e.layers.getLayers?e.layers:new LayerGroup({layers:e.layers});r[MapProperty.LAYERGROUP]=i,r[MapProperty.TARGET]=e.target,r[MapProperty.VIEW]=e.view instanceof View?e.view:new View;let n;void 0!==e.controls&&(n=Array.isArray(e.controls)?new Collection(e.controls.slice()):(assert("function"==typeof e.controls.getArray,"Expected `controls` to be an array or an `ol/Collection.js`"),e.controls));let s;void 0!==e.interactions&&(s=Array.isArray(e.interactions)?new Collection(e.interactions.slice()):(assert("function"==typeof e.interactions.getArray,"Expected `interactions` to be an array or an `ol/Collection.js`"),e.interactions));let o;return o=void 0!==e.overlays?Array.isArray(e.overlays)?new Collection(e.overlays.slice()):(assert("function"==typeof e.overlays.getArray,"Expected `overlays` to be an array or an `ol/Collection.js`"),e.overlays):new Collection,{controls:n,interactions:s,keyboardEventTarget:t,overlays:o,values:r}}export default Map;