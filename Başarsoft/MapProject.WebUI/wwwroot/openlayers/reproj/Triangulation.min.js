import{boundingExtent,createEmpty,extendCoordinate,getArea,getBottomLeft,getBottomRight,getTopLeft,getTopRight,getWidth,intersects}from"../extent.js";import{getTransform}from"../proj.js";import{modulo}from"../math.js";const MAX_SUBDIVISION=10,MAX_TRIANGLE_WIDTH=.25;class Triangulation{constructor(t,i,r,e,s,o){this.sourceProj_=t,this.targetProj_=i;let n={};const a=getTransform(this.targetProj_,this.sourceProj_);this.transformInv_=function(t){var i=t[0]+"/"+t[1];return n[i]||(n[i]=a(t)),n[i]},this.maxSourceExtent_=e,this.errorThresholdSquared_=s*s,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!e&&!!this.sourceProj_.getExtent()&&getWidth(e)>=getWidth(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?getWidth(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?getWidth(this.targetProj_.getExtent()):null;var t=getTopLeft(r),i=getTopRight(r),s=getBottomRight(r),e=getBottomLeft(r),h=this.transformInv_(t),d=this.transformInv_(i),u=this.transformInv_(s),_=this.transformInv_(e),r=MAX_SUBDIVISION+(o?Math.max(0,Math.ceil(Math.log2(getArea(r)/(o*o*256*256)))):0);if(this.addQuad_(t,i,s,e,h,d,u,_,r),this.wrapsXInSource_){let e=1/0;this.triangles_.forEach(function(t,i,r){e=Math.min(e,t.source[0][0],t.source[1][0],t.source[2][0])}),this.triangles_.forEach(t=>{if(Math.max(t.source[0][0],t.source[1][0],t.source[2][0])-e>this.sourceWorldWidth_/2){const r=[[t.source[0][0],t.source[0][1]],[t.source[1][0],t.source[1][1]],[t.source[2][0],t.source[2][1]]];r[0][0]-e>this.sourceWorldWidth_/2&&(r[0][0]-=this.sourceWorldWidth_),r[1][0]-e>this.sourceWorldWidth_/2&&(r[1][0]-=this.sourceWorldWidth_),r[2][0]-e>this.sourceWorldWidth_/2&&(r[2][0]-=this.sourceWorldWidth_);var i=Math.min(r[0][0],r[1][0],r[2][0]);Math.max(r[0][0],r[1][0],r[2][0])-i<this.sourceWorldWidth_/2&&(t.source=r)}})}n={}}addTriangle_(t,i,r,e,s,o){this.triangles_.push({source:[e,s,o],target:[t,i,r]})}addQuad_(i,r,e,s,o,n,a,h,d){var u=boundingExtent([o,n,a,h]),_=this.sourceWorldWidth_?getWidth(u)/this.sourceWorldWidth_:null,c=this.sourceWorldWidth_,g=this.sourceProj_.canWrapX()&&.5<_&&_<1;let l=!1;if(0<d&&(this.targetProj_.isGlobal()&&this.targetWorldWidth_&&(W=boundingExtent([i,r,e,s]),W=getWidth(W)/this.targetWorldWidth_,l=W>MAX_TRIANGLE_WIDTH||l),!g&&this.sourceProj_.isGlobal()&&_&&(l=_>MAX_TRIANGLE_WIDTH||l)),!(!l&&this.maxSourceExtent_&&isFinite(u[0])&&isFinite(u[1])&&isFinite(u[2])&&isFinite(u[3]))||intersects(u,this.maxSourceExtent_)){let t=0;if(!(l||isFinite(o[0])&&isFinite(o[1])&&isFinite(n[0])&&isFinite(n[1])&&isFinite(a[0])&&isFinite(a[1])&&isFinite(h[0])&&isFinite(h[1])))if(0<d)l=!0;else if(1!=(t=(isFinite(o[0])&&isFinite(o[1])?0:8)+(isFinite(n[0])&&isFinite(n[1])?0:4)+(isFinite(a[0])&&isFinite(a[1])?0:2)+(isFinite(h[0])&&isFinite(h[1])?0:1))&&2!=t&&4!=t&&8!=t)return;if(0<d){if(!l){var W=[(i[0]+e[0])/2,(i[1]+e[1])/2],_=this.transformInv_(W);let t;t=g?(modulo(o[0],c)+modulo(a[0],c))/2-modulo(_[0],c):(o[0]+a[0])/2-_[0];var u=(o[1]+a[1])/2-_[1],W=t*t+u*u;l=W>this.errorThresholdSquared_}if(l)return void(Math.abs(i[0]-e[0])<=Math.abs(i[1]-e[1])?(c=[(r[0]+e[0])/2,(r[1]+e[1])/2],_=this.transformInv_(c),u=[(s[0]+i[0])/2,(s[1]+i[1])/2],W=this.transformInv_(u),this.addQuad_(i,r,c,u,o,n,_,W,d-1),this.addQuad_(u,c,e,s,W,_,a,h,d-1)):(u=[(i[0]+r[0])/2,(i[1]+r[1])/2],c=this.transformInv_(u),W=[(e[0]+s[0])/2,(e[1]+s[1])/2],_=this.transformInv_(W),this.addQuad_(i,u,W,s,o,c,_,h,d-1),this.addQuad_(u,r,e,W,c,n,a,_,d-1)))}if(g){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}0==(11&t)&&this.addTriangle_(i,e,s,o,a,h),0==(14&t)&&this.addTriangle_(i,e,r,o,a,n),t&&(0==(13&t)&&this.addTriangle_(r,s,i,n,h,o),0==(7&t)&&this.addTriangle_(r,s,e,n,h,a))}}calculateSourceExtent(){const e=createEmpty();return this.triangles_.forEach(function(t,i,r){t=t.source;extendCoordinate(e,t[0]),extendCoordinate(e,t[1]),extendCoordinate(e,t[2])}),e}getTriangles(){return this.triangles_}}export default Triangulation;